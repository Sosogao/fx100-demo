<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>

<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>fx100 · Trade Ticket (V1)</title>
<style>
  :root{
  --page-pad-h: 20px;
    --bg:#0b0f14;
    --panel:#0f1520;
    --border:rgba(255,255,255,.08);
    --text:#e8edf6;
    --label:rgba(232,237,246,.55);
    --sub:rgba(232,237,246,.40);
    --focus:rgba(115,168,255,.18);

    --ok:#29d37d;
    --danger:#ff4d4f;

    --accentA: rgba(78, 227, 205, 0.95);
    --accentB: rgba(115,168,255,.90);

    --hi: rgba(115,168,255,.95);
    --hi2: rgba(78,227,205,.92);

    /* focus green (subtle) */
    --inputGreen: rgba(78,227,205,.92);

    --radius:16px;
    --radius2:12px;
    --mono:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;
    --shadow:0 18px 60px rgba(0,0,0,.55);
  }

  *{box-sizing:border-box}
  body{
    margin:0; min-height:100vh; display:grid; place-items:center;
    background:
      radial-gradient(900px 500px at 20% 10%, rgba(78,116,255,.10), transparent 55%),
      radial-gradient(800px 500px at 80% 30%, rgba(41,211,125,.08), transparent 60%),
      var(--bg);
    color:var(--text);
    font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
  }
  .wrap{ width:420px; max-width:calc(100vw - 24px); }
  .panel{
    background: linear-gradient(180deg, rgba(255,255,255,.02), rgba(255,255,255,.00)), var(--panel);
    border:1px solid var(--border);
    border-radius:var(--radius);
    box-shadow:var(--shadow);
    overflow:hidden;
  }

  .head{ padding:14px 16px 10px; border-bottom:1px solid var(--border); }
  .titleRow{ display:flex; align-items:center; justify-content:space-between; margin-bottom:10px; }
  .title{ font-size:13px; color:var(--label); letter-spacing:.2px; }
  .chip-mini{display:inline-flex;align-items:center;justify-content:center;padding:2px 8px;border-radius:999px;border:1px solid rgba(255,255,255,.10);background:rgba(255,255,255,.04);color:rgba(232,237,246,.70);font-size:11px;font-weight:700;letter-spacing:.02em;}
.badge{
    font-family:var(--mono);
    font-size:11px;
    padding:4px 8px;
    border-radius:999px;
    border:1px solid var(--border);
    background: rgba(255,255,255,.04);
    color:var(--label);
    user-select:none;
    white-space:nowrap;
  }

  .price-ticker{
    font-variant-numeric:tabular-nums;
    transition:color .16s ease;
  }
  .price-up{ color:var(--ok) !important; }
  .price-down{ color:var(--danger) !important; }
  @keyframes priceBump{
    0%{ transform:translateY(0); }
    30%{ transform:translateY(-2px); }
    60%{ transform:translateY(1px); }
    100%{ transform:translateY(0); }
  }
  .price-bump{ animation:priceBump .35s ease; }

  .tabs{ display:flex; border-bottom:1px solid rgba(255,255,255,.06); margin-bottom:10px; }
  .tab{
    flex:1; text-align:center; padding:10px 0;
    font-weight:800; font-size:13px;
    color:rgba(232,237,246,.55);
    cursor:pointer; user-select:none; position:relative;
  }
  .tab.on{ color:var(--text); }
  .tab.on::after{
    content:""; position:absolute; left:18%; right:18%; bottom:-1px;
    height:2px; background: var(--accentB); border-radius:999px;
  }

  .seg2{
    display:flex; gap:6px;
    background: rgba(255,255,255,.04);
    border:1px solid var(--border);
    border-radius:12px; padding:6px;
  }
  .seg2 button{
    flex:1; border:0; background:transparent;
    color:rgba(232,237,246,.55);
    font-weight:900; font-size:13px;
    padding:10px 10px; border-radius:10px;
    cursor:pointer;
    transition: background .15s, color .15s, transform .02s;
  }
  .seg2 button:active{ transform: translateY(1px); }
  .seg2 button.on.buy{ background: rgba(78,227,205,.22); color:var(--text); }
  .seg2 button.on.sell{ background: rgba(255,77,79,.16); color:var(--text); }

  .body{ padding:12px 16px 16px; display:flex; flex-direction:column; gap:12px; }

  .card{
    background: rgba(255,255,255,.02);
    border:1px solid var(--border);
    border-radius:var(--radius2);
    padding:12px;
  }

  .infoLine{
    display:flex; align-items:baseline; justify-content:space-between; gap:12px;
    margin-bottom:10px;
  }
  .infoLine .k{ font-size:12px; color:var(--label); }
  .infoLine .v{ font-family:var(--mono); font-size:12px; color:var(--text); }

  .field{
    display:flex; align-items:center; gap:10px;
    padding:10px 10px;
    border:1px solid var(--border);
    border-radius:12px;
    background: rgba(255,255,255,.04);
    transition: box-shadow .15s, border-color .15s;
  }
  .field:focus-within{
    box-shadow:0 0 0 3px var(--focus);
    border-color: rgba(115,168,255,.35);
  }
  .inLabel{
    font-size:12px;
    color:rgba(232,237,246,.45);
    font-weight:900;
    letter-spacing:.2px;
    user-select:none;
    white-space:nowrap;
  }

  input[type="number"]::-webkit-outer-spin-button,
  input[type="number"]::-webkit-inner-spin-button{ -webkit-appearance:none; margin:0; }
  input[type="number"]{ -moz-appearance:textfield; }

  input[type="number"]{
    width:100%;
    border:0;
    outline:none;
    background:transparent;
    color:var(--text);
    font-size:14px;
    text-align:right;
  }
  input[type="number"]::placeholder{
    color: rgba(232,237,246,.35);
  }

  /* Size: default white, focus green */
  #size{ color: var(--text); }
  .field:focus-within #size{ color: var(--inputGreen); }

  .unitSel{
    border:0; outline:none; background:transparent;
    color:var(--text);
    font-family:var(--mono);
    font-size:12px;
    padding-left:10px;
    border-left:1px solid rgba(255,255,255,.10);
    cursor:pointer;
    white-space:nowrap;
  }

  /* NEW: Size quick buttons */
  .sizeQuick{
    display:flex;
    gap:6px;
    margin-top:8px;
  }
  .sizeQuick button{
    font-size:11px;
    padding:4px 8px;
    border-radius:10px;
    border:1px solid rgba(255,255,255,.08);
    background:rgba(255,255,255,.03);
    color:rgba(232,237,246,.45);
    cursor:pointer;
    user-select:none;
    transition: border-color .15s, color .15s, background .15s, transform .02s;
  }
  .sizeQuick button:active{ transform: translateY(1px); }
  .sizeQuick button:hover{
    color:var(--text);
    border-color:rgba(115,168,255,.35);
    background:rgba(255,255,255,.045);
  }

  /* Quick size: transient active (500ms fade out) */
  .sizeQuick button.flash {
    color: rgba(232,237,246,.90);
    border-color: rgba(115,168,255,.45);
    background: rgba(115,168,255,.12);
    box-shadow: 0 0 0 3px rgba(115,168,255,.10);
    transition:
      background 500ms ease,
      border-color 500ms ease,
      box-shadow 500ms ease,
      color 500ms ease;
  }

  .rowLite{
    margin-top:10px;
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:10px;
    padding:8px 10px;
    border-radius:12px;
    border:1px solid rgba(255,255,255,.07);
    background: rgba(255,255,255,.02);
  }
  .rowLite .k{
    font-size:12px;
    color:rgba(232,237,246,.45);
    font-weight:800;
    letter-spacing:.2px;
    white-space:nowrap;
  }

  .posWrap{
    display:inline-flex;
    align-items:center;
    gap:8px;
    position:relative;
    min-width:0;
  }
  .posValue{
    font-family:var(--mono);
    font-size:12px;
    color: var(--hi2);
    cursor:default;
    white-space:nowrap;
  }
  .posHint{
    position:absolute;
    left:50%;
    transform: translate(-50%, 6px);
    top:-22px;
    font-size:11px;
    color:rgba(232,237,246,.42);
    background: rgba(0,0,0,.35);
    border:1px solid rgba(255,255,255,.08);
    padding:3px 7px;
    border-radius:999px;
    opacity:0;
    pointer-events:none;
    transition: opacity .15s, transform .15s;
    white-space:nowrap;
  }
  .posWrap:hover .posHint{
    opacity:1;
    transform: translate(-50%, 0px);
  }

  .toggle{
    width:40px; height:22px;
    border-radius:999px;
    border:1px solid rgba(255,255,255,.12);
    background: rgba(255,255,255,.06);
    position:relative;
    cursor:pointer;
    flex:0 0 auto;
    transition: background .15s, border-color .15s;
  }
  .toggle::after{
    content:"";
    position:absolute;
    top:50%;
    left:3px;
    width:16px; height:16px;
    border-radius:50%;
    transform: translateY(-50%);
    background: rgba(232,237,246,.92);
    box-shadow:0 10px 22px rgba(0,0,0,.45);
    transition: left .15s ease;
  }
  .toggle.on{
    background: rgba(78,227,205,.20);
    border-color: rgba(78,227,205,.25);
  }
  .toggle.on::after{ left:20px; }

  .levBox{ margin-top:12px; display:flex; flex-direction:column; gap:10px; }
  .levTop{ display:flex; align-items:center; justify-content:space-between; }
  .levTop .k{ font-size:12px; color:rgba(232,237,246,.45); font-weight:900; }
  .pill{
    font-family:var(--mono);
    font-size:12px;
    color:var(--text);
    background: rgba(255,255,255,.06);
    border:1px solid var(--border);
    padding:6px 10px;
    border-radius:999px;
    min-width:62px;
    text-align:center;
  }

  .levRail{
    position:relative;
    height:16px;
    border-radius:999px;
    overflow:hidden;
    border:1px solid rgba(255,255,255,.10);
    background:
      linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.02)),
      linear-gradient(90deg, rgba(115,168,255,.10), rgba(78,227,205,.10));
  }
  .levSeg{
    position:absolute; top:0; bottom:0;
    width:25%;
    border-right:1px solid rgba(255,255,255,.06);
    mix-blend-mode:screen;
  }
  .levSeg:last-child{ border-right:0; }

  .levFill{
    position:absolute; top:0; bottom:0; left:0;
    width:0%;
    background:
      linear-gradient(90deg,
        rgba(115,168,255,.20) 0%,
        rgba(115,168,255,.26) 18%,
        rgba(78,227,205,.22) 52%,
        rgba(78,227,205,.34) 100%);
  }
  .levFill::after{
    content:"";
    position:absolute;
    top:-8px; bottom:-8px;
    right:-30px;
    width:60px;
    background: radial-gradient(closest-side, rgba(115,168,255,.22), transparent 70%);
    filter: blur(2px);
    opacity:.9;
  }

  .levKnob{
    position:absolute;
    top:50%;
    width:18px; height:18px;
    border-radius:50%;
    transform: translate(-50%, -50%);
    background: rgba(232,237,246,.92);
    box-shadow:0 8px 20px rgba(0,0,0,.45);
    border: 1px solid rgba(0,0,0,.25);
    pointer-events:none;
  }

  .levSlider{
    position:absolute; inset:0;
    width:100%;
    opacity:0;
    cursor:pointer;
  }

  .ticks{
    display:flex;
    justify-content:space-between;
    padding:0 2px;
    margin-top:4px;
  }
  .tick{ width:1px; height:6px; background: rgba(255,255,255,.14); }

  .tpslMini{
    display:flex; align-items:center; justify-content:space-between; gap:10px;
    padding:8px 10px;
    border:1px solid rgba(255,255,255,.07);
    border-radius:12px;
    background: rgba(255,255,255,.015);
    cursor:pointer;
    user-select:none;
  }
  .tpslMini .txt{
    font-size:12px;
    font-weight:900;
    color:rgba(232,237,246,.55);
    white-space:nowrap;
    overflow:hidden;
    text-overflow:ellipsis;
  }
  .tpslMini.on .txt{ color:rgba(232,237,246,.80); }
  .chev{
    width:9px;height:9px;
    border-right:2px solid rgba(232,237,246,.45);
    border-bottom:2px solid rgba(232,237,246,.45);
    transform: rotate(45deg);
    transition: transform .18s ease;
    margin-right:2px;
    flex:0 0 auto;
  }
  .tpslMini.open .chev{ transform: rotate(225deg); }

  .tpslBody{
    display:grid;
    grid-template-rows:0fr;
    transition: grid-template-rows .22s ease, opacity .18s ease;
    opacity:0;
    padding:0 2px;
  }
  .tpslBody.open{ grid-template-rows:1fr; opacity:1; }
  .tpslInner{
    overflow:hidden;
    display:flex;
    flex-direction:column;
    gap:8px;
    padding-top:8px;
  }

  .inlinePct{
    font-family:var(--mono);
    font-size:12px;
    white-space:nowrap;
    padding-left:10px;
    border-left:1px solid rgba(255,255,255,.10);
    color: rgba(232,237,246,.35);
  }
  .pos{ color: rgba(41,211,125,.95); }
  .neg{ color: rgba(255,77,79,.95); }
  .mutedPct{ color: rgba(232,237,246,.35); }

  .preview{ display:flex; flex-direction:column; gap:12px; }
  .pRow{ display:flex; align-items:baseline; justify-content:space-between; gap:12px; }
  .pRow .k{ font-size:12px; color:var(--label); font-weight:600; }
  .pRow .v{ font-family:var(--mono); font-size:13px; color:var(--text); white-space:nowrap; }
  .pSub{ display:flex; align-items:baseline; justify-content:space-between; gap:12px; margin-top:-6px; }
  .pSub .k{ font-size:12px; color:rgba(232,237,246,.40); }
  .pSub .v{ font-family:var(--mono); font-size:12px; color:rgba(232,237,246,.55); }

  .vHi{ color: var(--hi); }
  .divider{ height:1px; background: rgba(255,255,255,.08); margin:2px 0; }

  .slipWrap{ display:inline-flex; align-items:center; gap:8px; position:relative; }
  .slipValue{
    font-family:var(--mono);
    font-size:12px;
    color:rgba(232,237,246,.75);
    border:1px solid rgba(255,255,255,.10);
    background: rgba(255,255,255,.03);
    padding:4px 8px;
    border-radius:999px;
    cursor:pointer;
    user-select:none;
  }
  .slipValue:hover{ border-color: rgba(115,168,255,.35); }
  .hint{
    position:absolute;
    right:0;
    top:-22px;
    font-size:11px;
    color:rgba(232,237,246,.42);
    background: rgba(0,0,0,.35);
    border:1px solid rgba(255,255,255,.08);
    padding:3px 7px;
    border-radius:999px;
    opacity:0;
    transform: translateY(4px);
    pointer-events:none;
    transition: opacity .15s, transform .15s;
    white-space:nowrap;
  }
  .slipWrap:hover .hint{ opacity:1; transform: translateY(0); }

  .slipEditor{ display:inline-flex; align-items:center; gap:6px; }
  .slipInput{
    width:64px;
    font-family:var(--mono);
    font-size:12px;
    text-align:right;
    color:var(--text);
    background: rgba(255,255,255,.04);
    border:1px solid rgba(255,255,255,.10);
    border-radius:10px;
    padding:6px 8px;
    outline:none;
  }
  .pctSym{ font-family:var(--mono); font-size:12px; color:rgba(232,237,246,.55); }

.btn{
  width:100%;
  border-radius:14px;
  padding:12px 14px;
  font-weight:950;
  font-size:14px;
  cursor:pointer;

  /* calmer primary action: white text, muted fill */
  color: rgba(255,255,255,.92);
  border: 1px solid rgba(255,255,255,.10);
  background: rgba(255,255,255,.06);

  transition: transform .02s, opacity .15s, filter .15s, background .15s, border-color .15s;
}
.btn{
  color: rgba(255,255,255,.96);
  border: 1px solid rgba(255,255,255,.14);
  background:
    linear-gradient(180deg,
      rgba(255,255,255,.10),
      rgba(255,255,255,.04));
}

/* slightly stronger, still muted */
.btn.buy{
  background:
    linear-gradient(180deg,
      rgba(78,227,205,.30),
      rgba(78,227,205,.18));
  border-color: rgba(78,227,205,.28);
}

.btn.sell{
  background:
    linear-gradient(180deg,
      rgba(255,77,79,.30),
      rgba(255,77,79,.18));
  border-color: rgba(255,77,79,.28);
}

.btn:hover{
  filter: brightness(1.06);
  box-shadow: 0 6px 18px rgba(0,0,0,.25);
}

.btn:disabled{ opacity:.45; cursor:not-allowed; filter:saturate(.7); }


  /* NEW: lightweight dividers around CTA (so user can ignore details) */
  .ctaDivider{
    height:1px;
    background:rgba(255,255,255,.06);
    margin:6px 0;
  }

  .err{ font-size:12px; color:rgba(255,77,79,.95); margin-top:8px; }
  .hidden{ display:none !important; }

  /* --- Limit/Size stacking: less cramped --- */
  .fieldStack{
    display:flex;
    flex-direction:column;
    gap:10px;
    margin-top:10px;
  }
  .fieldStack .field{ padding:12px 12px; }

  .inLabel{ min-width:92px; }

  .sizeQuick{ margin-top:10px; }

  /* --- Details rows: allow hide by mode --- */
  .pRow.hiddenRow, .pSub.hiddenRow{ display:none !important; }

  /* --- Liquidation Protection (15m) --- */
  .protBanner{
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:12px;
    padding:10px 12px;
    border-radius:14px;
    border:1px solid rgba(255,255,255,.08);
    background:
      linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.01));
    user-select:none;
  }
  .protLeft{
    display:flex;
    align-items:center;
    gap:10px;
    min-width:0;
  }
  .shield{
    width:22px;height:22px;
    border-radius:8px;
    display:grid;
    place-items:center;
    border:1px solid rgba(41,211,125,.22);
    background: rgba(41,211,125,.08);
    color: rgba(41,211,125,.95);
    flex:0 0 auto;
  }
  .protTxt{ display:flex; flex-direction:column; gap:2px; min-width:0; }
  .protT1{
    font-size:12px;
    font-weight:950;
    color: rgba(232,237,246,.70);
    letter-spacing:.2px;
    white-space:nowrap;
    overflow:hidden;
    text-overflow:ellipsis;
  }
  .protT2{
    font-size:11px;
    color: rgba(232,237,246,.38);
    white-space:nowrap;
    overflow:hidden;
    text-overflow:ellipsis;
  }
  .protRight{
    font-family: var(--mono);
    font-size:12px;
    padding:6px 10px;
    border-radius:999px;
    border:1px solid rgba(255,255,255,.10);
    background: rgba(255,255,255,.03);
    color: rgba(232,237,246,.85);
    white-space:nowrap;
  }
  .protRight.active{
    border-color: rgba(41,211,125,.22);
    background: rgba(41,211,125,.10);
    color: rgba(41,211,125,.95);
  }


/* ===== Positions Actions Modals (Market Close / Reverse / TP-SL) ===== */
:root{
  --actClose: rgba(255,255,255,.78);
  --actRevLong: rgba(43,212,164,.92);
  --actRevShort: rgba(244,91,91,.92);
  --actTp: rgba(43,212,164,.85);
  --actSl: rgba(244,91,91,.85);
}
.actions .linklike{
  padding: 6px 8px;
  border-radius: 10px;
  border: 1px solid rgba(232,237,246,.10);
  background: rgba(255,255,255,.03);
  transition: transform .12s ease, background .12s ease, border-color .12s ease;
}
.actions .linklike:hover{
  background: rgba(255,255,255,.06);
  border-color: rgba(232,237,246,.18);
}
.actions .act-close{ color: var(--actClose); }
.actions .act-reverse{ color: rgba(255,255,255,.82); }
.actions .act-tpsl{ color: rgba(255,255,255,.82); }

/* Modal system (shared) */
.fx-modal-overlay{
  position: fixed; inset: 0;
  background: rgba(0,0,0,.55);
  backdrop-filter: blur(8px);
  z-index: 2000;
  display: none;
}
.fx-modal{
  position: fixed;
  top: 50%; left: 50%;
  transform: translate(-50%,-50%);
  width: min(420px, calc(100vw - 24px));
  max-height: min(560px, calc(100vh - 80px));
  background: linear-gradient(180deg, rgba(255,255,255,.02), rgba(255,255,255,.00)), var(--panel);
  border: 1px solid var(--border);
  box-shadow: var(--shadow);
  border-radius: var(--radius);
  z-index: 2001;
  display: none;
  flex-direction: column;
  overflow: hidden;
}
.fx-modal .m-hd{
  padding: 16px 16px 12px;
  display:flex; align-items:center; justify-content:space-between;
  gap: 10px;
  border-bottom: 1px solid rgba(255,255,255,.06);
}
.fx-modal .m-title{
  display:flex; flex-direction:column; gap: 2px;
}
.fx-modal .m-title .t1{ font-weight: 700; letter-spacing:.2px; }
.fx-modal .m-title .t2{
  font-size: 12px;
  color: var(--label);
  margin-top: 4px;
}
.fx-modal .m-x{
  width: 34px; height: 34px;
  display:flex; align-items:center; justify-content:center;
  border-radius: 12px;
  background: rgba(255,255,255,.04);
  border: 1px solid rgba(232,237,246,.12);
  cursor: pointer;
}
.fx-modal .m-bd{
  padding: 20px;
  flex: 1 1 auto;
  overflow-y: auto;
  display:flex;
  flex-direction:column;
  gap:20px;
}
.fx-modal .m-bd::-webkit-scrollbar{
  width: 6px;
}
.fx-modal .m-bd::-webkit-scrollbar-track{
  background: rgba(255,255,255,.02);
}
.fx-modal .m-bd::-webkit-scrollbar-thumb{
  background: rgba(115,168,255,.45);
  border-radius: 999px;
}
.fx-modal .m-ft{
  padding: 14px 16px 16px;
}
.fx-modal .m-ft .btn{ width:100%; }
.fx-modal .btn{
  width:100%;
  border-radius:14px;
  padding:12px 14px;
  font-weight:950;
  font-size:14px;
  border: 1px solid rgba(255,255,255,.14);
  background:
    linear-gradient(180deg,
      rgba(255,255,255,.10),
      rgba(255,255,255,.04));
  color: rgba(255,255,255,.96);
  transition: transform .02s, opacity .15s, filter .15s, background .15s, border-color .15s;
  display:flex;
  align-items:center;
  justify-content:center;
  line-height:1.1;
}
.fx-modal .btn.buy{
  background:
    linear-gradient(180deg,
      rgba(78,227,205,.30),
      rgba(78,227,205,.18));
  border-color: rgba(78,227,205,.28);
}
.fx-modal .btn.sell{
  background:
    linear-gradient(180deg,
      rgba(255,77,79,.30),
      rgba(255,77,79,.18));
  border-color: rgba(255,77,79,.28);
}
.fx-modal .btn:hover{
  filter: brightness(1.08);
  box-shadow: 0 8px 22px rgba(0,0,0,.35);
}
.fx-row{ display:flex; gap: 10px; align-items:center; }
.fx-row.between{ justify-content:space-between; }
.fx-grow{ flex:1; }
.fx-label{ font-size: 12px; color: var(--muted); margin-bottom: 6px; }
.fx-input{
  width: 100%;
  height: 40px;
  border-radius: 14px;
  border: 1px solid rgba(232,237,246,.12);
  background: rgba(255,255,255,.03);
  color: var(--fg);
  padding: 0 12px;
  outline: none;
}
.fx-input:focus{
  border-color: rgba(115,168,255,.55);
  box-shadow: 0 0 0 3px rgba(115,168,255,.12);
}
.fx-pill{
  display:inline-flex; align-items:center; gap: 6px;
  padding: 6px 10px;
  border-radius: 999px;
  border: 1px solid rgba(232,237,246,.10);
  background: rgba(255,255,255,.03);
  color: rgba(255,255,255,.82);
  font-size: 12px;
}
.fx-mini{ font-size: 12px; color: var(--muted); }
.fx-kbd{ font-family: ui-monospace, SFMono-Regular, Menlo, monospace; font-size: 11px; opacity:.85; }
.fx-modal-card{
  border: 1px solid var(--border);
  border-radius: var(--radius2);
  padding: 16px;
  background: rgba(255,255,255,.02);
}
.fx-modal-card > * + *{ margin-top:16px; }
.fx-modal-card .field{
  background: rgba(255,255,255,.03);
}
.fx-sliderBlock{ margin-top: 20px; }
.fx-sliderRail{
  position:relative;
  height:16px;
  border-radius:999px;
  border:1px solid rgba(255,255,255,.10);
  background:
    linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.02)),
    linear-gradient(90deg, rgba(115,168,255,.18), rgba(78,227,205,.18));
  overflow:hidden;
}
.fx-sliderFill{
  position:absolute; top:0; bottom:0; left:0;
  width:0%;
  background:
    linear-gradient(90deg,
      rgba(115,168,255,.20) 0%,
      rgba(115,168,255,.26) 25%,
      rgba(78,227,205,.28) 60%,
      rgba(78,227,205,.38) 100%);
  pointer-events:none;
}
.fx-sliderFill::after{
  content:"";
  position:absolute;
  top:-8px; bottom:-8px;
  right:-30px;
  width:60px;
  background: radial-gradient(closest-side, rgba(115,168,255,.22), transparent 70%);
  filter: blur(2px);
  opacity:.85;
}
.fx-sliderTicks{
  position:absolute;
  inset:0;
  display:flex;
  justify-content:space-between;
  padding:0 6px;
  pointer-events:none;
}
.fx-sliderTicks span{
  width:1px;
  height:6px;
  background: rgba(255,255,255,.16);
  align-self:center;
}
.fx-sliderKnob{
  position:absolute;
  top:50%;
  width:18px; height:18px;
  border-radius:50%;
  transform: translate(-50%, -50%);
  background: rgba(232,237,246,.92);
  box-shadow:0 8px 20px rgba(0,0,0,.45);
  border: 1px solid rgba(0,0,0,.25);
  pointer-events:none;
}
.fx-sliderInput{
  position:absolute;
  inset:0;
  width:100%;
  opacity:0;
  cursor:pointer;
}
.fx-sliderLabels{
  display:flex;
  justify-content:space-between;
  font-size:11px;
  color: rgba(232,237,246,.45);
  margin-top:10px;
}

</style>


<style>
/* ===== Page layout (V1) ===== */
:root{
  --page-bg-0: #060B12;
  --page-bg-1: #050A10;
  --stroke-1: rgba(255,255,255,.08);
  --stroke-2: rgba(255,255,255,.12);
  --text-1: rgba(232,237,246,.92);
  --text-2: rgba(232,237,246,.56);
  --text-3: rgba(232,237,246,.38);
}
html,body{ height:100%; }
body{
  margin:0;
  /* Override the trade-ticket prototype's centering grid so the full page layout can stretch */
  display:block !important;
  place-items: initial !important;
  justify-items: stretch !important;
  align-items: stretch !important;
  background: radial-gradient(1200px 800px at 40% -10%, rgba(61,120,255,.10), transparent 60%),
              radial-gradient(900px 700px at 90% 30%, rgba(37,206,174,.08), transparent 55%),
              linear-gradient(180deg, var(--page-bg-0), var(--page-bg-1));
  overflow-x:hidden;
}


/* Global nav (FX100) */
.nav{
  position:sticky; top:0; z-index:20;
  backdrop-filter: blur(12px);
  background: rgba(6,11,18,.72);
  border-bottom: 1px solid var(--stroke-1);
}
.nav-inner{
  width:100%;
  padding: 10px var(--page-pad-h);
  display:flex; align-items:center; justify-content:space-between;
  gap:16px;
}
.brand{
  display:flex; align-items:center; gap:10px;
  color: var(--text-1);
  font-weight:800;
  letter-spacing:.2px;
}
.brand .logo{
  width:18px; height:18px; border-radius:6px;
  background: linear-gradient(135deg, rgba(37,206,174,.9), rgba(61,120,255,.9));
  box-shadow: 0 10px 26px rgba(0,0,0,.35);
}
.nav-links{
  display:flex; gap:14px; align-items:center;
  color: var(--text-2);
  font-size:13px;
}
.nav-links a{
  color: inherit; text-decoration:none;
  padding: 6px 8px;
  border-radius: 10px;
}
.nav-links a:hover{ color: var(--text-1); background: rgba(255,255,255,.04); }
.nav-links a.active{ color: rgba(210,255,246,.92); background: rgba(37,206,174,.10); border: 1px solid rgba(37,206,174,.18); }

.nav-right{ display:flex; align-items:center; gap:10px; }
.btn{
  height:34px;
  padding: 0 12px;
  border-radius: 10px;
  border: 1px solid var(--stroke-1);
  background: rgba(255,255,255,.03);
  color: var(--text-1);
  font-weight:700;
  font-size:12px;
  cursor:pointer;
}
.btn:hover{ border-color: var(--stroke-2); }
.btn.ghost{ color: var(--text-2); font-weight:700; }
.btn.primary{
  background: linear-gradient(180deg, rgba(37,206,174,.22), rgba(37,206,174,.10));
  border-color: rgba(37,206,174,.22);
  color: rgba(210,255,246,.92);
}
.fav-bar{
  background: rgba(6,11,18,.82);
  border: 1px solid var(--stroke-1);
  border-radius: 14px;
}
.fav-inner{
  padding: 8px 12px;
  display:flex;
  align-items:center;
  gap:10px;
  overflow:auto;
}
.fav-pill{
  display:inline-flex;
  align-items:center;
  gap:6px;
  padding:6px 10px;
  border-radius:10px;
  border:1px solid var(--stroke-1);
  background: rgba(255,255,255,.03);
  font-size:12px;
  color:var(--text-2);
  white-space:nowrap;
}
.fav-pill .sym{
  font-weight:700;
  color: var(--text-1);
}
.fav-pill .chg.up{ color: var(--dirLong); }
.fav-pill .chg.down{ color: var(--dirShort); }
.fav-actions{
  display:inline-flex;
  align-items:center;
  gap:6px;
  margin-right:10px;
}
.fav-actions button{
  border:1px solid var(--stroke-1);
  background: rgba(255,255,255,.03);
  color: var(--text-1);
  border-radius:8px;
  padding:4px 8px;
  font-size:12px;
  cursor:pointer;
}
.fav-actions button.active{
  background: rgba(37,206,174,.18);
  border-color: rgba(37,206,174,.32);
  color: rgba(210,255,246,.92);
}

/* Top bar */
.topbar{
  backdrop-filter: blur(10px);
  background: rgba(6,11,18,.68);
  border: 1px solid var(--stroke-1);
  border-radius: 14px;
}
.topbar-inner{
  width: 100%;
  margin: 0;
  padding: 10px 12px;
  display:flex; align-items:center; gap:14px;
}
.market-pill{
  display:flex; align-items:center; gap:10px;
  padding: 8px 10px;
  border: 1px solid var(--stroke-1);
  border-radius: 12px;
  background: rgba(255,255,255,.03);
  color: var(--text-1);
  min-width: 180px;
}
.market-pill .logo{
  width:20px;
  height:20px;
  border-radius:50%;
  background: radial-gradient(circle at 30% 30%, rgba(255,255,255,.35), rgba(115,168,255,.05));
  border:1px solid rgba(255,255,255,.12);
  display:flex;
  align-items:center;
  justify-content:center;
}
.market-pill .logo::before{
  content:"Ξ";
  font-size:12px;
  color:rgba(255,255,255,.85);
}
.market-pill .pair{ font-weight:700; letter-spacing:.2px; }
.market-pill .lev{
  font-size:12px; padding: 3px 8px; border-radius:999px;
  background: rgba(37,206,174,.12);
  border: 1px solid rgba(37,206,174,.22);
  color: rgba(210,255,246,.92);
}

.market-pill{
  cursor:pointer;
  user-select:none;
}
.market-pill:focus{ outline:none; box-shadow: 0 0 0 2px rgba(88,150,255,.22); }
.market-pill .caret{
  margin-left:4px;
  font-size:12px;
  color: rgba(190,210,235,.75);
  transform: translateY(1px);
}
.market-pill:hover .caret{ color: rgba(230,245,255,.88); }
/* Market selector (Hyperliquid-like) */
.mkt-overlay{
  position: fixed; inset: 0;
  background: rgba(0,0,0,.30);
  backdrop-filter: blur(2px);
  opacity:0; pointer-events:none;
  transition: opacity .14s ease;
  z-index: 2000;
}
.mkt-overlay.open{ opacity:1; pointer-events:auto; }

.mkt-modal{
  position: fixed;
  width: min(760px, calc(100vw - 24px));
  max-height: min(560px, calc(100vh - 110px));
  overflow: hidden;
  border-radius: 16px;
  background: rgba(12,18,28,.88);
  border: 1px solid rgba(255,255,255,.08);
  box-shadow: 0 26px 80px rgba(0,0,0,.55);
  z-index: 2001;
  opacity:0; transform: translateY(-6px) scale(.995);
  pointer-events:none;
  transition: opacity .16s ease, transform .16s ease;
}
.mkt-modal.open{ opacity:1; transform: translateY(0) scale(1); pointer-events:auto; }

.mkt-head{ padding: 12px 14px 10px; border-bottom: 1px solid rgba(255,255,255,.06); }
.mkt-row1{ display:flex; gap:10px; align-items:center; }
.mkt-search{
  flex:1;
  height: 36px;
  border-radius: 10px;
  background: rgba(255,255,255,.04);
  border: 1px solid rgba(255,255,255,.08);
  color: var(--text-1);
  padding: 0 12px;
  font-size: 13px;
}
.mkt-search::placeholder{ color: rgba(210,225,245,.45); }
.mkt-toggle{
  display:flex; gap:8px; align-items:center;
  background: rgba(255,255,255,.03);
  border: 1px solid rgba(255,255,255,.07);
  border-radius: 10px;
  padding: 3px;
}
.mkt-toggle button{
  height: 28px;
  padding: 0 12px;
  border-radius: 8px;
  border: 0;
  background: transparent;
  color: rgba(210,225,245,.65);
  font-size: 12px;
  cursor:pointer;
}
.mkt-toggle button.active{
  background: rgba(37,206,174,.16);
  border: 1px solid rgba(37,206,174,.25);
  color: rgba(225,255,250,.95);
}
.mkt-tabs{
  margin-top: 10px;
  display:flex; gap:14px; align-items:center;
  color: rgba(210,225,245,.65);
  font-size: 12px;
}
.mkt-tabs button{
  border:0; background: transparent;
  color: inherit;
  padding: 6px 0;
  cursor:pointer;
  position:relative;
}
.mkt-tabs button.active{ color: rgba(235,245,255,.92); }
.mkt-tabs button.active::after{
  content:"";
  position:absolute; left:0; right:0; bottom:-10px;
  height:2px;
  background: rgba(37,206,174,.75);
  border-radius: 999px;
}

.mkt-body{ padding: 10px 0 8px; }
.mkt-table{
  width:100%;
  border-collapse: collapse;
  font-size: 12px;
  color: rgba(215,230,250,.72);
}
.mkt-table thead th{
  text-align:left;
  font-weight:600;
  color: rgba(210,225,245,.55);
  padding: 8px 14px;
}
.mkt-table tbody tr{
  cursor:pointer;
}
.mkt-table tbody tr:hover{
  background: rgba(255,255,255,.04);
}
.mkt-table td{
  padding: 9px 14px;
  border-top: 1px solid rgba(255,255,255,.06);
  vertical-align: middle;
}
.mkt-sym{
  display:flex; align-items:center; gap:8px;
  font-weight:700;
  color: rgba(235,245,255,.92);
}
.mkt-star{
  width: 14px; height:14px;
  border:1px solid rgba(255,255,255,.16);
  border-radius: 4px;
  display:inline-flex; align-items:center; justify-content:center;
  color: rgba(255,255,255,.35);
  font-size: 10px;
}
.mkt-pill{
  font-size:11px;
  padding: 2px 7px;
  border-radius: 999px;
  border: 1px solid rgba(37,206,174,.25);
  background: rgba(37,206,174,.12);
  color: rgba(210,255,246,.92);
}
.mkt-pill.dim{
  border-color: rgba(120,150,255,.22);
  background: rgba(120,150,255,.10);
  color: rgba(220,230,255,.92);
}
.mkt-num{ font-variant-numeric: tabular-nums; }
.mkt-up{ color: rgba(37,206,174,.95); }
.mkt-down{ color: rgba(255,110,110,.95); }

.mkt-foot{
  border-top: 1px solid rgba(255,255,255,.06);
  padding: 10px 14px;
  display:flex; flex-wrap:wrap;
  gap:10px 14px;
  color: rgba(210,225,245,.45);
  font-size: 11px;
}
.kbd{
  display:inline-flex;
  align-items:center;
  gap:6px;
}
.kbd b{
  font-weight:700;
  color: rgba(235,245,255,.75);
  border: 1px solid rgba(255,255,255,.12);
  background: rgba(255,255,255,.04);
  padding: 2px 6px;
  border-radius: 6px;
}
.stats{
  display:flex; gap:18px; flex:1; flex-wrap:wrap;
  color: var(--text-2);
  font-size:12px;
}
.stat b{ color: var(--text-1); font-weight:700; font-variant-numeric: tabular-nums; }
.stat .down{ color: rgba(255,110,110,.95); }
.stat .up{ color: rgba(37,206,174,.95); }
.top-actions{ display:flex; align-items:center; gap:10px; }
.icon-btn{
  width:34px; height:34px; border-radius:10px;
  border: 1px solid var(--stroke-1);
  background: rgba(255,255,255,.03);
  color: var(--text-2);
  display:grid; place-items:center;
  cursor:pointer;
}
.icon-btn:hover{ border-color: var(--stroke-2); color: var(--text-1); }

/* Main grid */
.page{
  width: 100%;
  margin: 0;
  padding: 16px var(--page-pad-h);
}
.main{
  display:grid;
  grid-template-columns: minmax(960px, 1fr) 420px;
  gap: 16px;
  align-items:start;
}

.left-stack{
  display:flex;
  flex-direction:column;
  gap:12px;
  min-width:0;
}
.left{
  min-width:0;
  display:flex;
  flex-direction:column;
  gap:14px;
}
.bottom{ margin-top: 0; }
/* Keep side-by-side layout longer (ticket is 420px) */
/* Stack only on very narrow screens. 800px should still show chart+positions left and ticket right. */
@media (max-width: 740px){
  .main{ grid-template-columns: 1fr; }
}

/* Chart shell */
.chart-shell{
  border: 1px solid var(--stroke-1);
  border-radius: 16px;
  background: rgba(255,255,255,.02);
  overflow:hidden;
  min-height: 520px;
}
.chart-header{
  display:flex; align-items:center; justify-content:space-between;
  padding: 10px 12px;
  border-bottom: 1px solid var(--stroke-1);
}
.chart-left{
  display:flex; align-items:center; gap:10px; color: var(--text-1);
  font-weight:700; font-size:13px;
}
.chip-mini{display:inline-flex;align-items:center;justify-content:center;padding:2px 8px;border-radius:999px;border:1px solid rgba(255,255,255,.10);background:rgba(255,255,255,.04);color:rgba(232,237,246,.70);font-size:11px;font-weight:700;letter-spacing:.02em;}
.badge{
  font-size:12px; padding: 4px 8px; border-radius:999px;
  border: 1px solid var(--stroke-1);
  background: rgba(255,255,255,.03);
  color: var(--text-2);
}
.chart-canvas{
  height: 470px;
  position:relative;
}
.tv-chart{
  position:absolute;
  inset:0;
}
.chart-placeholder{
  position:absolute; inset:0;
  display:flex; align-items:center; justify-content:center;
  color: var(--text-3);
  font-size:13px;
  user-select:none;
}

/* Bottom panel */
.bottom{
  margin-top: 14px;
  border: 1px solid var(--stroke-1);
  border-radius: 16px;
  background: rgba(255,255,255,.02);
  overflow:hidden;
}
.bottom-tabs{
  display:flex; gap: 14px; align-items:center; flex-wrap: nowrap;
  padding: 10px 12px;
  border-bottom: 1px solid var(--stroke-1);
}
.bottom-tabs .tab{
  padding: 6px 8px;
  border-radius: 10px;
  color: var(--text-2);
  cursor:pointer;
  user-select:none;
}
.bottom-tabs .tab.active{
  color: var(--text-1);
  background: rgba(255,255,255,.04);
  border: 1px solid rgba(255,255,255,.06);
}
.bottom-tools{
  margin-left:auto;
  display:flex; align-items:center; gap:10px;
  color: var(--text-2);
  font-size:12px;
}
.dropdown{
  position:relative;
}
.dropbtn{
  display:flex; align-items:center; gap:8px;
  padding: 6px 10px;
  border-radius: 10px;
  border: 1px solid var(--stroke-1);
  background: rgba(255,255,255,.03);
  cursor:pointer;
  color: var(--text-2);
}
.dropbtn:hover{ border-color: var(--stroke-2); color: var(--text-1); }
.menu{
  position:absolute; right:0; top: calc(100% + 8px);
  min-width: 140px;
  border-radius: 12px;
  border: 1px solid var(--stroke-1);
  background: rgba(10,14,20,.92);
  backdrop-filter: blur(12px);
  overflow:hidden;
  display:none;
  z-index:20;
}
.menu .item{
  padding: 10px 12px;
  color: var(--text-2);
  cursor:pointer;
  font-size:12px;
}
.menu .item:hover{ background: rgba(255,255,255,.04); color: var(--text-1); }
.dropdown.open .menu{ display:block; }

/* Tables */
.table-wrap{ overflow:auto; width:100%; }
.table{
  width:100%;
  border-collapse: collapse;
  table-layout: fixed;
  min-width: 100%;
}
.table th, .table td{
  text-align:left;
  padding: 10px 12px;
  border-bottom: 1px solid rgba(255,255,255,.06);
  color: var(--text-2);
  font-size:12px;
  white-space:nowrap;
  overflow:hidden;
  text-overflow: ellipsis;
}
.table th{ color: rgba(232,237,246,.42); font-weight:600; }
.table td b{ color: var(--text-1); font-weight:700; }
.table td.actions{
  overflow:visible;
  text-overflow:initial;
}
#tablePositions th:last-child,
#tablePositions td.actions{
  width:200px;
}
.table td.actions{
  overflow:visible;
  text-overflow:initial;
}
.pill-action{
  display:inline-flex; align-items:center; gap:8px;
  padding: 5px 10px;
  border-radius: 999px;
  border: 1px solid rgba(255,255,255,.08);
  background: rgba(255,255,255,.03);
  color: var(--text-2);
  cursor:pointer;
}
.pill-action:hover{ border-color: rgba(255,255,255,.14); color: var(--text-1); }
.linklike{ color: rgba(37,206,174,.95); cursor:pointer; }
.linklike:hover{ text-decoration: underline; }
.dir-long{ color: rgba(37,206,174,.95) !important; }
.dir-short{ color: rgba(255,110,110,.95) !important; }

/* Direction color semantics (global) */
:root{
  --dirLong: rgba(37,206,174,.95);
  --dirShort: rgba(255,110,110,.95);
}
.dir-long, .dir-long b{ color: var(--dirLong) !important; }
.dir-short, .dir-short b{ color: var(--dirShort) !important; }

/* Table row hover: lift the whole row slightly */
.table tbody tr{ transition: background 140ms ease, box-shadow 140ms ease; }
.table tbody tr:hover{ background: rgba(255,255,255,.028); }
.table tbody tr:hover td{ background: rgba(255,255,255,.028); }

/* Actions: only highlight the hovered action, not the entire row */
.actions .linklike{
  color: rgba(232,237,246,.55);
  text-decoration: none;
  transition: color 120ms ease, opacity 120ms ease;
}
.actions .linklike:hover{
  color: var(--text-1);
  text-decoration: none;
}
.actions .linklike:active{ opacity:.8; }

/* Action color semantics (subtle but noticeable) */
:root{
  --actClose: rgba(37,206,174,.92);
  --actReduce: rgba(115,168,255,.92);
  --actReverse: rgba(255,208,120,.92);
  --actTPSL: rgba(232,237,246,.62);
}
.actions .act-close{ color: var(--actClose); }
.actions .act-reduce{ color: var(--actReduce); }
.actions .act-reverse{ color: var(--actReverse); }
.actions .act-tpsl{ color: var(--actTPSL); }
.actions .linklike{ text-decoration:none; }
.actions .linklike:hover{ filter: brightness(1.06); text-decoration:none; }

/* Directional leverage chip (e.g. ETH 3x) */
.chip-mini.dir-long{
  border-color: rgba(37,206,174,.22);
  background: rgba(37,206,174,.08);
  color: var(--dirLong);
}
.chip-mini.dir-short{
  border-color: rgba(255,110,110,.22);
  background: rgba(255,110,110,.08);
  color: var(--dirShort);
}

/* Protection countdown: gently fade when < 1 min (no red) */
.prot-badge{ transition: opacity 200ms ease; }
.prot-low{ opacity: .58; }

/* Make the existing ticket wrap behave inside right pane */
.wrap{ min-height: unset !important; padding: 0 !important; background: transparent !important; }
.panel{ margin: 0 !important; }


/* --- Bottom tabs: keep labels compact (no full-width stretching) --- */
.bottom-tabs{ display:flex; align-items:center; gap:10px; flex-wrap:nowrap; }
.bottom-tabs .tab{
  flex:0 0 auto;
  padding:10px 14px;
  border-radius: 12px;
  text-align:center;
}
.bottom-tools{ margin-left:auto; display:flex; align-items:center; gap:10px; }
.brand-mark{
  height: 36px;
  width: auto;
  display:block;
  filter: drop-shadow(0 6px 12px rgba(0,0,0,.45));
}
.nav-left{
  display:flex;
  align-items:center;
  gap:12px;
  padding:4px 10px;
  border-radius:12px;
  border:1px solid var(--stroke-1);
  background: rgba(255,255,255,.02);
}
</style>

</head>
<body>


<div class="nav">
  <div class="nav-inner">
    <div style="display:flex; align-items:center; gap:18px; min-width: 420px;">
      <div class="nav-left">
        <img
          src="https://raw.githubusercontent.com/Sosogao/fx100-demo/main/assets/fx100-logo.png"
          alt="FX100"
          class="brand-mark"
          width="150"
          height="60"
        />
      </div>
      <div class="nav-links" aria-label="Primary">
        <a class="active" href="javascript:void(0)">Trade</a>
        <a href="javascript:void(0)">Portfolio</a>
        <a href="javascript:void(0)">Vaults</a>
        <a href="javascript:void(0)">Referrals</a>
        <a href="javascript:void(0)">Leaderboard</a>
        <a href="javascript:void(0)">More ▾</a>
      </div>
    </div>
    <div class="nav-right">
      <button class="btn ghost" title="Language">EN ▾</button>
      <button class="btn ghost" title="Settings">⚙︎</button>
      <button class="btn primary" title="Connect wallet">Connect</button>
    </div>
  </div>
</div>
<div class="page">
  <div class="main">
    <div class="left-stack">
      <div class="fav-bar">
        <div class="fav-inner">
          <div class="fav-actions">
            <button class="active">☆</button>
            <button>%</button>
          </div>
          <div class="fav-pill">
            <span class="sym">BTC-USDC</span>
            <span class="chg up">+0.05%</span>
          </div>
          <div class="fav-pill">
            <span class="sym">ETH-USDC</span>
            <span class="chg up">+0.23%</span>
          </div>
          <div class="fav-pill">
            <span class="sym">SOL-USDC</span>
            <span class="chg down">-0.16%</span>
          </div>
          <div class="fav-pill">
            <span class="sym">XRP-USDC</span>
            <span class="chg down">-0.20%</span>
          </div>
          <div class="fav-pill">
            <span class="sym">XYZ100-USDC</span>
            <span class="chg down">-0.04%</span>
          </div>
        </div>
      </div>
      <div class="topbar">
        <div class="topbar-inner">
          <button class="market-pill" id="marketBtn" type="button" aria-haspopup="dialog" aria-expanded="false">
            <div class="logo" aria-hidden="true"></div>
            <div class="pair">ETH-USDC</div>
            <span class="lev">100x</span>
            <span class="badge">Oracle</span>
                <span class="caret" aria-hidden="true">▾</span>
          </button>
          <div class="stats">
            <div class="stat">Oracle <b id="statOracle">4,302.15</b></div>
            <div class="stat">24H Change <b class="down" id="statChg">-2.14 / 3.23%</b></div>
            <div class="stat">24H Volume <b id="statVol">$1.64B</b></div>
            <div class="stat">Open Interest <b id="statOI">$3.06B</b></div>
            <div class="stat">Funding <b class="up" id="statFunding">0.0013%</b></div>
          </div>
          <div class="top-actions">
            <button class="icon-btn" title="Settings" aria-label="Settings">⚙︎</button>
            <button class="icon-btn" title="Fullscreen" aria-label="Fullscreen">⤢</button>
          </div>
        </div>
      </div>
      <div class="left">
      <div class="chart-shell">
      <div class="chart-canvas">
        <div id="tvChart" class="tv-chart"></div>
      </div>
    </div>

      <div class="bottom" id="bottomPanel">
          <div class="bottom-tabs">
            <div class="tab active" data-tab="positions">Positions (2)</div>
            <div class="tab" data-tab="orders">Open Orders (8)</div>
            <div class="tab" data-tab="trades">Trade History</div>
            <div class="tab" data-tab="funding">Funding History</div>
            <div class="tab" data-tab="history">Order History</div>
      
            <div class="bottom-tools">
              <div class="dropdown" id="filterDrop">
                <div class="dropbtn">Filter <span id="filterLabel">All</span> ▾</div>
                <div class="menu">
                  <div class="item" data-filter="all">All</div>
                  <div class="item" data-filter="active">Active</div>
                  <div class="item" data-filter="long">Long</div>
                  <div class="item" data-filter="short">Short</div>
                </div>
              </div>
              <div class="pill-action" id="cancelAllBtn" style="display:none;">Cancel All</div>
            </div>
          </div>
      
          <div class="table-wrap">
            <table class="table" id="tablePositions">
              <thead>
                <tr>
  <th>Coin</th><th>Direction</th><th>Size</th><th>Position Value</th>
  <th>Entry Price</th><th>Oracle</th><th>PNL (ROE%)</th><th>Liq. / Prot</th>
  <th>Margin Used</th><th>Funding</th><th>Actions</th>
</tr>
              </thead>
              <tbody id="posBody"></tbody>
            </table>
      
            <table class="table" id="tableOrders" style="display:none;">
              <thead>
                <tr>
  <th>Time</th><th>Type</th><th>Coin</th><th>Direction</th><th>Size</th>
  <th>Order Value</th><th>Trigger Price</th><th>Reduce Only</th>
  <th>Trigger</th><th>Status</th><th>Cancel</th>
</tr>
              </thead>
              <tbody id="ordBody"></tbody>
            </table>
      
            <table class="table" id="tableTrades" style="display:none;">
              <thead>
                <tr><th>Time</th><th>Coin</th><th>Direction</th><th>Price</th><th>Size</th><th>Trade Value</th><th>Fee</th><th>Closed PNL</th></tr>
              </thead>
              <tbody id="trdBody"></tbody>
            </table>
      
            <table class="table" id="tableFunding" style="display:none;">
              <thead>
                <tr><th>Time</th><th>Coin</th><th>Size</th><th>Position Side</th><th>Payment</th><th>Rate</th></tr>
              </thead>
              <tbody id="fundBody"></tbody>
            </table>
      
            <table class="table" id="tableHistory" style="display:none;">
              <thead>
                <tr>
  <th>Time</th><th>Type</th><th>Coin</th><th>Direction</th><th>Size</th><th>Filled Size</th>
  <th>Order Value</th><th>Trigger</th><th>Reduce Only</th><th>Status</th>
</tr>
              </thead>
              <tbody id="histBody"></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <div class="ticket-pane">
      <div class="wrap">
  <div class="panel">
    <div class="head">
      <div class="tabs" id="tabs">
        <div class="tab on" data-tab="market">Market</div>
        <div class="tab" data-tab="limit">Limit</div>
      </div>

      <div class="seg2" id="sideSeg">
        <button class="on buy" data-side="buy">Buy / Long</button>
        <button class="sell" data-side="sell">Sell / Short</button>
      </div>
    </div>

    <div class="body">
      <div class="card">
        <div class="infoLine">
          <div class="k">Available to Trade</div>
          <div class="v" id="availV">--</div>
        </div>

        <div class="fieldStack">
<div class="field hidden" id="limitCard" style="margin-top:10px;">
            <div class="inLabel">Trigger Price</div>
            <input id="limitPrice" type="number" inputmode="decimal" placeholder="0.0" step="0.01"/>
            <div class="inlinePct mutedPct" style="padding-left:10px;border-left:1px solid rgba(255,255,255,.10);">USDC</div>
          </div>
          

        <div class="field" id="sizeField">
        
          <div class="inLabel">Size</div>
          <input id="size" type="number" inputmode="decimal" placeholder="0.0" step="0.0001"/>
          <select class="unitSel" id="sizeUnit" aria-label="Size unit">
            <option value="ETH" selected>ETH</option>
            <option value="USDC">USDC</option>
          </select>
        </div>
        </div>

        <!-- NEW: 25/50/75/Max -->
        <div class="sizeQuick" id="sizeQuick">
          <button type="button" data-p="0.25">25%</button>
          <button type="button" data-p="0.50">50%</button>
          <button type="button" data-p="0.75">75%</button>
          <button type="button" data-p="1">Max</button>
        </div>

        <div class="levBox" id="levBox">
          <div class="levTop">
            <div class="k">Leverage</div>
            <div class="pill" id="levPill">5x</div>
          </div>

          <div class="levRail">
            <div class="levFill" id="levFill"></div>
            <div class="levSeg" style="left:25%"></div>
            <div class="levSeg" style="left:50%"></div>
            <div class="levSeg" style="left:75%"></div>
            <div class="levKnob" id="levKnob"></div>
            <input class="levSlider" id="lev" type="range" min="1" max="25" value="5" step="1" aria-label="Leverage slider"/>
          </div>

          <div class="ticks" aria-hidden="true">
            <div class="tick"></div><div class="tick"></div><div class="tick"></div><div class="tick"></div><div class="tick"></div>
            <div class="tick"></div><div class="tick"></div><div class="tick"></div><div class="tick"></div><div class="tick"></div>
          </div>
        </div>

        
        <div class="rowLite hidden" id="reduceRow">
          <div class="k">Reduce-only</div>

          <div class="posWrap" id="posWrap">
            <span class="posHint">Current Position</span>
            <span class="posValue" id="posValue">0.0000 ETH</span>
          </div>

          <div class="toggle" id="reduceToggle" role="switch" aria-checked="false" tabindex="0"></div>
        </div>
        <div class="err" id="sizeErr" style="display:none;"></div>
      </div>

      <div class="card" id="tpslCard" style="padding:10px 12px;">
        <div class="tpslMini" id="tpslMini">
          <div class="txt" id="tpslSummary">TP/SL · Off</div>
          <div class="chev" aria-hidden="true"></div>
        </div>

        <div class="tpslBody" id="tpslBody">
          <div class="tpslInner">
            <div class="field" style="background:rgba(255,255,255,.03);">
              <div class="inLabel">TP</div>
              <input id="tp" type="number" inputmode="decimal" placeholder="0.0" step="0.01"/>
              <div class="inlinePct" id="tpPct">—</div>
            </div>

            <div class="field" style="background:rgba(255,255,255,.03);">
              <div class="inLabel">SL</div>
              <input id="sl" type="number" inputmode="decimal" placeholder="0.0" step="0.01"/>
              <div class="inlinePct" id="slPct">—</div>
            </div>
          </div>
        </div>
      </div>


      <!-- Liquidation Protection (preview / countdown) -->
      <div class="protBanner" id="protBanner">
        <div class="protLeft">
          <div class="shield" aria-hidden="true">🛡</div>
          <div class="protTxt">
            <div class="protT1" id="protTitle">Liquidation Protection · 15 min</div>
            <div class="protT2" id="protSub">No liquidation during the first 15 minutes after opening</div>
          </div>
        </div>
        <div class="protRight" id="protRight">15 min</div>
      </div>

      <!-- NEW: CTA moved ABOVE details -->
      <div class="ctaDivider"></div>
      <button class="btn buy" id="submitBtn" disabled>Place Buy / Long</button>
      <div class="ctaDivider"></div>

      <!-- Details remain optional -->
      <div class="card">
        <div class="preview">
          <div class="pRow"><div class="k">Order Value</div><div class="v" id="orderValueV">--</div></div>

          <div class="pRow" id="entryRow"><div class="k">Estimated Entry</div><div class="v vHi" id="entryV">--</div></div>
          <div class="pSub" id="impactRow"><div class="k">Price Impact</div><div class="v" id="impactV">--</div></div>

          <div class="pRow" id="slipRow">
            <div class="k">Slippage</div>
            <div class="v">
              <span class="slipWrap">
                <span class="hint">Click to adjust</span>
                <span class="slipValue" id="slipValue">0.30%</span>
                <span class="slipEditor hidden" id="slipEditor">
                  <input class="slipInput" id="slipInput" type="number" step="0.01" inputmode="decimal"/>
                  <span class="pctSym">%</span>
                </span>
              </span>
            </div>
          </div>

          <div class="pRow"><div class="k">Liquidation</div><div class="v" id="liqV">--</div></div>

          <div class="divider"></div>

          <div class="pRow"><div class="k">Fee</div><div class="v" id="feeV">--</div></div>
          <div class="pRow"><div class="k" id="marginK">Margin Used</div><div class="v" id="marginV">--</div></div>
        </div>
      </div>

    </div>
  </div>
</div>
    </div>
  </div>
</div>

<script>
(function(){
  const subs = new Set();
  let lastPrice = null;
  let lastDir = "flat";
  const FEED_URL = "https://api.binance.com/api/v3/ticker/price?symbol=ETHUSDT";

  async function pull(){
    try{
      const res = await fetch(FEED_URL, {cache:"no-store"});
      if(!res.ok) throw new Error(`HTTP ${res.status}`);
      const data = await res.json();
      const value = Number(data?.price);
      if(!Number.isFinite(value)) return;
      const dir = lastPrice == null ? "flat" : (value > lastPrice ? "up" : value < lastPrice ? "down" : "flat");
      lastPrice = value;
      lastDir = dir;
      const payload = { price:value, direction:dir, ts:Date.now() };
      subs.forEach(fn => {
        try{ fn(payload); } catch(err){ console.error(err); }
      });
    }catch(err){
      console.warn("Live price feed error", err);
    }
  }

  function start(){
    pull();
    setInterval(pull, 4000);
  }

  window.fxPriceFeed = {
    subscribe(fn){
      if(typeof fn !== "function") return () => {};
      subs.add(fn);
      if(lastPrice != null) fn({ price:lastPrice, direction:lastDir, ts:Date.now() });
      return () => subs.delete(fn);
    },
    getPrice(){ return lastPrice; },
    getDirection(){ return lastDir; }
  };

  start();
})();
</script>

<script>
(() => {

  // ===== Market selector (Hyperliquid-like, simplified) =====
  const marketData = [
    {symbol:"BTC-USDC", lev:"100x", category:"Perps", last:"90,721", chg:"+207 / +0.23%", chgDir:"up", fund:"0.0100%", vol:"$3.10B", oi:"$2.67B"},
    {symbol:"ETH-USDC", lev:"100x", category:"Perps", last:"4,302.15", chg:"-2.14%", chgDir:"down", fund:"0.0013%", vol:"$1.64B", oi:"$3.06B"},
    {symbol:"SOL-USDC", lev:"20x", category:"Perps", last:"139.32", chg:"+3.50 / +2.58%", chgDir:"up", fund:"0.0100%", vol:"$601M", oi:"$654M"},
    {symbol:"XRP-USDC", lev:"20x", category:"Perps", last:"2.2122", chg:"+0.0036 / +0.17%", chgDir:"up", fund:"0.0100%", vol:"$181M", oi:"$301M"},
    {symbol:"PEPE-USDC", lev:"10x", category:"Perps", last:"0.000616", chg:"-0.000025 / -3.90%", chgDir:"down", fund:"0.0100%", vol:"$62.4M", oi:"$45.5M"},
    {symbol:"XYZ100-USDC", lev:"25x", category:"Trending", last:"25.481", chg:"-126 / -0.49%", chgDir:"down", fund:"0.0050%", vol:"$214.7M", oi:"$95.8M"},
    {symbol:"FARTCOIN-USDC", lev:"10x", category:"Crypto", last:"0.40333", chg:"+0.01055 / +2.69%", chgDir:"up", fund:"0.0212%", vol:"$51.4M", oi:"$90.6M"},
    {symbol:"ZEC-USDC", lev:"10x", category:"Perps", last:"441.53", chg:"-3.22 / -0.72%", chgDir:"down", fund:"0.0100%", vol:"$349M", oi:"$229M"},
  ];

  const mkt = {
    btn: document.getElementById('marketBtn'),
    overlay: null,
    modal: null,
    drawer: null,
    tbody: null,
    q: null,
    strictBtn: null,
    allBtn: null,
    tabs: null,
  };
  const statOracleEl = document.getElementById('statOracle');
  const priceFeed = window.fxPriceFeed;
  let oracleFlashTimer = null;
  const fmtOracle = (n) => Number.isFinite(n)
    ? n.toLocaleString(undefined, {minimumFractionDigits:2, maximumFractionDigits:2})
    : "--";
  function animateOracle(direction){
    if(!statOracleEl) return;
    statOracleEl.classList.add('price-ticker');
    statOracleEl.classList.toggle('price-up', direction === 'up');
    statOracleEl.classList.toggle('price-down', direction === 'down');
    statOracleEl.classList.add('price-bump');
    clearTimeout(oracleFlashTimer);
    oracleFlashTimer = setTimeout(()=> statOracleEl.classList.remove('price-bump'), 320);
  }
  function updateOraclePrice(price, direction){
    if(!statOracleEl || !Number.isFinite(price)) return;
    statOracleEl.textContent = fmtOracle(price);
    animateOracle(direction);
  }

  function mktEnsure() {
    if (!mkt.overlay) mkt.overlay = document.getElementById('mktOverlay');
    if (!mkt.modal) mkt.modal = document.getElementById('mktModal');
    if (!mkt.drawer) mkt.drawer = document.getElementById('mktDrawer');
    if (!mkt.tbody) mkt.tbody = document.getElementById('mktTbody');
    if (!mkt.q) mkt.q = document.getElementById('mktSearch');
    if (!mkt.strictBtn) mkt.strictBtn = document.getElementById('mktStrict');
    if (!mkt.allBtn) mkt.allBtn = document.getElementById('mktAll');
    if (!mkt.tabs) mkt.tabs = Array.from(document.querySelectorAll('[data-mkt-tab]'));
  }

  let mktOpen = false;
  let mktTab = 'All';
  let mktStrictMode = true;
  let mktActiveIndex = 0;
  let mktFiltered = [];

  function setBtnExpanded(v){
    if(!mkt.btn) return;
    mkt.btn.setAttribute('aria-expanded', v ? 'true' : 'false');
  }

  function positionMarketModal(){
    if(!mkt.btn || !mkt.modal) return;
    const r = mkt.btn.getBoundingClientRect();
    const pad = 12;
    const top = Math.min(window.innerHeight - mkt.modal.offsetHeight - pad, r.bottom + 10);
    let left = r.left;
    // keep inside viewport
    const maxLeft = window.innerWidth - mkt.modal.offsetWidth - pad;
    left = Math.max(pad, Math.min(left, maxLeft));
    mkt.modal.style.top = top + "px";
    mkt.modal.style.left = left + "px";
  }

  function openMarket(){
    mktEnsure();
    if(!mkt.modal || !mkt.overlay) return;
    if(mktOpen) return;
    mktOpen = true;
    setBtnExpanded(true);
    mkt.overlay.classList.add('open');
    mkt.modal.classList.add('open');
    mkt.overlay.setAttribute('aria-hidden','false');
    positionMarketModal();
    renderMarket();
    setTimeout(()=> mkt.search?.focus(), 0);
  }

  function closeMarket(){
    mktEnsure();
    if(!mkt.modal || !mkt.overlay) return;
    if(!mktOpen) return;
    mktOpen = false;
    setBtnExpanded(false);
    mkt.overlay.classList.remove('open');
    mkt.modal.classList.remove('open');
    mkt.overlay.setAttribute('aria-hidden','true');
    mkt.search?.blur();
  }

  function toggleMarket(){ mktOpen ? closeMarket() : openMarket(); }

  function applyFilter(){
    const q = (mkt.search?.value || '').trim().toLowerCase();
    mktFiltered = marketData.filter(row => {
      const tabOk = (mktTab === 'All') ? true : (row.category === mktTab);
      if(!tabOk) return false;
      if(!q) return true;
      if(mktStrictMode) return row.symbol.toLowerCase().startsWith(q) || row.symbol.toLowerCase().includes(q);
      return row.symbol.toLowerCase().includes(q);
    });
    if(mktFiltered.length === 0) mktActiveIndex = 0;
    else mktActiveIndex = Math.max(0, Math.min(mktActiveIndex, mktFiltered.length-1));
  }

  function marketRowHTML(row, idx){
    const chgCls = row.chgDir === 'up' ? 'mkt-up' : (row.chgDir === 'down' ? 'mkt-down' : '');
    const levPillCls = row.lev === 'SPOT' ? 'mkt-pill dim' : 'mkt-pill';
    const activeStyle = idx === mktActiveIndex ? ' style="background: rgba(255,255,255,.035)"' : '';
    return `
      <tr data-idx="${idx}"${activeStyle}>
        <td>
          <div class="mkt-sym">
            <span class="mkt-star">☆</span>
            <span>${row.symbol}</span>
            <span class="${levPillCls}">${row.lev}</span>
          </div>
        </td>
        <td class="mkt-num">${row.last}</td>
        <td class="mkt-num ${chgCls}">${row.chg}</td>
        <td class="mkt-num">${row.fund}</td>
        <td class="mkt-num">${row.vol}</td>
        <td class="mkt-num">${row.oi}</td>
      </tr>
    `;
  }

  function renderMarket(){
    if(!mkt.tbody) return;
    applyFilter();
    mkt.tbody.innerHTML = mktFiltered.map((r,i)=>marketRowHTML(r,i)).join('');
  }

  function selectMarket(row){
    const pairEl = document.querySelector('.market-pill .pair');
    const logoEl = document.querySelector('.market-pill .logo');
    const levEl = document.querySelector('.market-pill .lev');
    if(pairEl) pairEl.textContent = row.symbol;
    if(levEl) levEl.textContent = row.lev === 'SPOT' ? 'Spot' : row.lev;
    if(logoEl) logoEl.textContent = (row.symbol || '').includes('BTC') ? '₿' : 'Ξ';
    // update small stats (keep simple)
    const oracleEl = document.getElementById('statOracle');
    const chgEl = document.getElementById('statChg');
    const volEl = document.getElementById('statVol');
    const oiEl = document.getElementById('statOI');
    const fundEl = document.getElementById('statFunding');
    if(oracleEl) oracleEl.textContent = row.last;
    if(chgEl){
      chgEl.textContent = row.chg.includes('%') ? row.chg : row.chg.split('/').pop().trim();
      chgEl.classList.toggle('down', row.chgDir==='down');
      chgEl.classList.toggle('up', row.chgDir==='up');
    }
    if(volEl) volEl.textContent = row.vol;
    if(oiEl) oiEl.textContent = row.oi;
    if(fundEl) fundEl.textContent = row.fund;
    // chart label
    const chartTitle = document.getElementById('chartSymbol');
    if(chartTitle) chartTitle.textContent = row.symbol.replace('USDc','USDC').replace('/',' · ');
    closeMarket();
  }

  // events
  if(mkt.btn){
    mkt.btn.addEventListener('click', (e)=>{ e.preventDefault(); toggleMarket(); });
  }
  mkt.overlay?.addEventListener('click', closeMarket);
  window.addEventListener('resize', ()=>{ if(mktOpen) positionMarketModal(); });

  mkt.search?.addEventListener('input', ()=>{ mktActiveIndex=0; renderMarket(); });
  mkt.search?.addEventListener('keydown', (e)=>{
    if(e.key === 'Escape'){ e.preventDefault(); closeMarket(); return; }
    if(e.key === 'ArrowDown'){ e.preventDefault(); mktActiveIndex = Math.min(mktActiveIndex+1, Math.max(0,mktFiltered.length-1)); renderMarket(); return; }
    if(e.key === 'ArrowUp'){ e.preventDefault(); mktActiveIndex = Math.max(mktActiveIndex-1, 0); renderMarket(); return; }
    if(e.key === 'Enter'){
      e.preventDefault();
      const row = mktFiltered[mktActiveIndex];
      if(row) selectMarket(row);
      return;
    }
  });

  mkt.tabs?.addEventListener('click', (e)=>{
    const btn = e.target.closest('button[data-tab]');
    if(!btn) return;
    mktTab = btn.getAttribute('data-tab');
    [...mkt.tabs.querySelectorAll('button')].forEach(b=>b.classList.toggle('active', b===btn));
    mktActiveIndex = 0;
    renderMarket();
  });

  function setStrictMode(v){
    mktStrictMode = v;
    mkt.strict?.classList.toggle('active', v);
    mkt.all?.classList.toggle('active', !v);
    renderMarket();
  }
  mkt.strict?.addEventListener('click', ()=> setStrictMode(true));
  mkt.all?.addEventListener('click', ()=> setStrictMode(false));

  mkt.tbody?.addEventListener('mousemove', (e)=>{
    const tr = e.target.closest('tr[data-idx]');
    if(!tr) return;
    const idx = parseInt(tr.getAttribute('data-idx')||'0',10);
    if(!Number.isNaN(idx) && idx!==mktActiveIndex){
      mktActiveIndex = idx;
      renderMarket();
    }
  });
  mkt.tbody?.addEventListener('click', (e)=>{
    const tr = e.target.closest('tr[data-idx]');
    if(!tr) return;
    const idx = parseInt(tr.getAttribute('data-idx')||'0',10);
    const row = mktFiltered[idx];
    if(row) selectMarket(row);
  });

  // Global shortcut ⌘K / Ctrl+K
  window.addEventListener('keydown', (e)=>{
    const isK = (e.key || '').toLowerCase() === 'k';
    const cmdk = (e.metaKey || e.ctrlKey) && isK;
    if(cmdk){
      e.preventDefault();
      toggleMarket();
      return;
    }
    if(e.key === 'Escape' && mktOpen){
      e.preventDefault();
      closeMarket();
    }
  });
  if(priceFeed && typeof priceFeed.subscribe === "function"){
    priceFeed.subscribe(({price, direction}) => {
      updateOraclePrice(price, direction);
    });
  }
  // Mock data (replace with real)
  const market = { oraclePrice: 4302.15, feeRate: 0.0005, maxLev: 25 };
  const wallet = { availableUSDC: 1000 };

  const position = {
    hasPosition: false,
    side: "long",      // "long" | "short"
    sizeEth: 0.1000,
  

    // Liquidation Protection: granted on open, lasts 15 minutes
    protection: {
      active: false,
      endTime: 0
    }
  };
  window.__fx100Position = position;


  const state = {
    tab: "market",
    side: "buy",       // "buy" | "sell"
    size: 0,
    unit: "ETH",
    lev: 5,
    limitPrice: null,

    reduceOnly: false,
    reduceOnlyManual: false,

    slippagePct: 0.30,
    _slipDraftPrev: null,

    tpslEnabled: false,
    tpslOpen: false,
    tp: null,
    sl: null
  };

  const SNAP_LEV = [1, 5, 10, 25];

  const $ = (id) => document.getElementById(id);

  const availV = $("availV");
  const tabs = $("tabs");
  const sideSeg = $("sideSeg");

  const size = $("size");
  const sizeUnit = $("sizeUnit");
  const sizeQuick = $("sizeQuick"); // NEW

  const reduceRow = $("reduceRow");
  const reduceToggle = $("reduceToggle");
  const posValue = $("posValue");

  const lev = $("lev");
  const levPill = $("levPill");
  const levFill = $("levFill");
  const levKnob = $("levKnob");

  const limitCard = $("limitCard");
  const limitPrice = $("limitPrice");

  const tpslCard = $("tpslCard");
  const tpslMini = $("tpslMini");
  const tpslBody = $("tpslBody");
  const tpslSummary = $("tpslSummary");
  const tp = $("tp");
  const sl = $("sl");
  const tpPct = $("tpPct");
  const slPct = $("slPct");

  const sizeErr = $("sizeErr");

  const orderValueV = $("orderValueV");
  const entryV = $("entryV");
  const liqV = $("liqV");
  const feeV = $("feeV");
  const impactV = $("impactV");
  const marginV = $("marginV");
  const levBox = $("levBox");
  const marginK = $("marginK");
  const entryRow = $("entryRow");
  const impactRow = $("impactRow");
  const slipRow = $("slipRow");

  const slipValue = $("slipValue");
  const slipEditor = $("slipEditor");
  const slipInput = $("slipInput");

  const submitBtn = $("submitBtn");
  // Liquidation Protection elements
  const protBanner = $("protBanner");
  const protTitle = $("protTitle");
  const protSub = $("protSub");
  const protRight = $("protRight");

  let liveEntryPrice = null;
  let liveEntryDirection = "flat";
  let entryFlashTimer = null;
  function bumpEntryTicker(){
    if(!entryV) return;
    entryV.classList.add("price-ticker","price-bump");
    clearTimeout(entryFlashTimer);
    entryFlashTimer = setTimeout(() => entryV.classList.remove("price-bump"), 350);
  }

  const fmt = (n, d=2) => Number.isFinite(n)
    ? n.toLocaleString(undefined, {minimumFractionDigits:d, maximumFractionDigits:d})
    : "--";
  const fmtUsd = (n) => Number.isFinite(n)
    ? `${n.toLocaleString(undefined, {minimumFractionDigits:2, maximumFractionDigits:2})} USDC`
    : "--";

  function sideToDir(){ return state.side === "buy" ? "long" : "short"; }

  function nowMs(){ return Date.now(); }
  function startProtection(){
    position.protection.active = true;
    position.protection.endTime = nowMs() + 15 * 60 * 1000;
  }
  function clearProtection(){
    position.protection.active = false;
    position.protection.endTime = 0;
  }
  function remainingProtectionMs(){
    if (!position.protection.active) return 0;
    return Math.max(0, position.protection.endTime - nowMs());
  }
  function fmtMMSS(ms){
    const s = Math.max(0, Math.floor(ms / 1000));
    const mm = String(Math.floor(s / 60)).padStart(2, "0");
    const ss = String(s % 60).padStart(2, "0");
    return `${mm}:${ss}`;
  }

  function estimateImpactPct(orderValueUsd){
    return Math.min(0.006, (orderValueUsd / 250000) * 0.0015);
  }
  function calcEstimatedEntry(dir, oracle, impactPct){
    return dir === "long" ? oracle * (1 + impactPct) : oracle * (1 - impactPct);
  }
  function calcLiquidation(entry, dir, lev){
    const k = 0.9 / Math.max(1, lev);
    return dir === "long" ? entry * (1 - k) : entry * (1 + k);
  }

  function computePreview(){
    if (!(state.size > 0)) {
      return { entry:NaN, liq:NaN, orderValue:NaN, feeUsd:NaN, feeRate:market.feeRate, impactPct:NaN, marginUsed:NaN };
    }
    const roughValue = state.unit === "USDC" ? state.size : state.size * market.oraclePrice;
    const impactPct = estimateImpactPct(roughValue);

    const dir = sideToDir();
    const entry = calcEstimatedEntry(dir, market.oraclePrice, impactPct);

    const orderValue = state.unit === "USDC" ? state.size : state.size * entry;
    const liq = calcLiquidation(entry, dir, state.lev);

    const feeUsd = orderValue * market.feeRate;
    const marginUsed = orderValue / state.lev;

    return { entry, liq, orderValue, feeUsd, feeRate:market.feeRate, impactPct, marginUsed };
  }

  // NEW: max size logic for 25/50/75/Max
  function maxSizeForUnit(p){
    // Reduce-only: cap to current position
    if (position.hasPosition && state.reduceOnly) {
      if (state.unit === "ETH") return Math.max(0, position.sizeEth);
      const px = Number.isFinite(p.entry) ? p.entry : market.oraclePrice;
      return Math.max(0, position.sizeEth * px);
    }

    // Normal: max order value = available * leverage
    const maxOrderValueUSDC = wallet.availableUSDC * state.lev;

    if (state.unit === "USDC") return Math.max(0, maxOrderValueUSDC);

    const px = Number.isFinite(p.entry) ? p.entry : market.oraclePrice;
    return px > 0 ? Math.max(0, maxOrderValueUSDC / px) : 0;
  }

  function setSizeFromPct(pct){
    // Use current preview to get a reasonable entry
    const p = computePreview();
    const max = maxSizeForUnit(p);
    const next = max * pct;

    state.size = next;
    const d = (state.unit === "ETH") ? 4 : 2;
    size.value = next ? next.toFixed(d) : "";

    // feel: keep focus on Size
    size.focus();
    render();
  }

  function pctFromPrice(targetPrice, entry, dir){
    if (!Number.isFinite(targetPrice) || !(targetPrice > 0) || !Number.isFinite(entry) || !(entry > 0)) return null;
    const raw = (targetPrice / entry - 1) * 100;
    if (dir === "short") return -raw;
    return raw;
  }

  function setLevVisual(){
    const pct = (state.lev - 1) / (market.maxLev - 1);
    const x = Math.round(pct * 1000) / 10; // 0.1%
    levFill.style.width = `${x}%`;
    levKnob.style.left = `${x}%`;
  }

  function nearestSnapLev(v){
    let best = SNAP_LEV[0];
    let bestD = Math.abs(v - best);
    for (const p of SNAP_LEV) {
      const d = Math.abs(v - p);
      if (d < bestD) { bestD = d; best = p; }
    }
    return (bestD <= 2) ? best : v;
  }

  function applyAutoReduceOnly(reason){
    if (!position.hasPosition) {
      state.reduceOnly = false;
      state.reduceOnlyManual = false;
      return;
    }
    const dir = sideToDir();
    const opposite = (position.side === "long" && dir === "short") || (position.side === "short" && dir === "long");

    if (reason === "directionChanged") {
      state.reduceOnlyManual = false;
      state.reduceOnly = opposite;
      return;
    }
    if (!state.reduceOnlyManual) state.reduceOnly = opposite;
  }

  function clampSizeIfNeeded(){
    if (!(state.size > 0)) return;
    const p = computePreview();
    const max = maxSizeForUnit(p);
    if (Number.isFinite(max) && max >= 0 && state.size > max) {
      state.size = max;
      const d = (state.unit === "ETH") ? 4 : 2;
      size.value = max ? max.toFixed(d) : "";
    }
  }

  function render(){
    availV.textContent = fmtUsd(wallet.availableUSDC);

    [...tabs.querySelectorAll(".tab")].forEach(t => t.classList.toggle("on", t.dataset.tab === state.tab));
    [...sideSeg.querySelectorAll("button")].forEach(b => {
      const on = b.dataset.side === state.side;
      b.classList.toggle("on", on);
      b.classList.toggle("buy", b.dataset.side === "buy");
      b.classList.toggle("sell", b.dataset.side === "sell");
    });

    if (state.tab === "limit") {
      limitCard.classList.remove("hidden");
      if (!(Number.isFinite(state.limitPrice) && state.limitPrice > 0)) {
        state.limitPrice = market.oraclePrice;
        limitPrice.value = String(market.oraclePrice.toFixed(2));
      }
    } else {
      limitCard.classList.add("hidden");
    }

    // Limit mode: hide slippage / estimated entry / price impact (oracle trigger -> market exec)
    const isLimit = state.tab === "limit";
    entryRow.classList.toggle("hiddenRow", isLimit);
    impactRow.classList.toggle("hiddenRow", isLimit);
    slipRow.classList.toggle("hiddenRow", isLimit);

    if (position.hasPosition) {
      reduceRow.classList.remove("hidden");
      posValue.textContent = `${position.sizeEth.toFixed(4)} ETH`;
      reduceToggle.classList.toggle("on", state.reduceOnly);
      reduceToggle.setAttribute("aria-checked", String(state.reduceOnly));
      // Reduce-only UX: hide leverage section (no leverage changes when reducing)
      levBox.classList.toggle("hidden", !!state.reduceOnly);
    } else {
      reduceRow.classList.add("hidden");
      state.reduceOnly = false;
      state.reduceOnlyManual = false;
      levBox.classList.remove("hidden");
    }

    levPill.textContent = `${state.lev}x`;
    setLevVisual();

    slipValue.textContent = `${state.slippagePct.toFixed(2)}%`;

    const p = computePreview();
    const dir = sideToDir();

    // Hide TP/SL when reduce-only is on
    const hideTpsl = !!state.reduceOnly;
    tpslCard.classList.toggle("hidden", hideTpsl);
    if (hideTpsl) {
      state.tpslEnabled = false;
      state.tpslOpen = false;
      state.tp = null;
      state.sl = null;
    }

    // TP/SL
    tpslMini.classList.toggle("on", state.tpslEnabled);
    tpslMini.classList.toggle("open", state.tpslOpen);
    tpslBody.classList.toggle("open", state.tpslOpen);

    if (!state.tpslEnabled) {
      tpslSummary.textContent = "TP/SL · Off";
      tpPct.textContent = "—"; slPct.textContent = "—";
      tpPct.className = "inlinePct mutedPct";
      slPct.className = "inlinePct mutedPct";
    } else {
      const tpTxt = Number.isFinite(state.tp) ? fmt(state.tp, 2) : "—";
      const slTxt = Number.isFinite(state.sl) ? fmt(state.sl, 2) : "—";
      if (Number.isFinite(state.tp) || Number.isFinite(state.sl)) {
        const parts = [];
        if (Number.isFinite(state.tp)) parts.push(`TP ${tpTxt}`);
        if (Number.isFinite(state.sl)) parts.push(`SL ${slTxt}`);
        tpslSummary.textContent = parts.join(" / ");
      } else {
        tpslSummary.textContent = "TP/SL · On";
      }

      const tpP = pctFromPrice(state.tp, p.entry, dir);
      const slP = pctFromPrice(state.sl, p.entry, dir);

      if (tpP === null) { tpPct.textContent="—"; tpPct.className="inlinePct mutedPct"; }
      else {
        const s = tpP >= 0 ? "+" : "";
        tpPct.textContent = `${s}${tpP.toFixed(2)}%`;
        tpPct.className = `inlinePct ${tpP >= 0 ? "pos" : "neg"}`;
      }

      if (slP === null) { slPct.textContent="—"; slPct.className="inlinePct mutedPct"; }
      else {
        const s = slP >= 0 ? "+" : "";
        slPct.textContent = `${s}${slP.toFixed(2)}%`;
        slPct.className = `inlinePct ${slP >= 0 ? "pos" : "neg"}`;
      }
    }

    // Preview
    orderValueV.textContent = Number.isFinite(p.orderValue) ? fmtUsd(p.orderValue) : "--";
    const priceForEntry = Number.isFinite(liveEntryPrice) ? liveEntryPrice : p.entry;
    if (Number.isFinite(priceForEntry)) {
      entryV.textContent = fmt(priceForEntry, 2);
      entryV.classList.add("price-ticker");
      entryV.classList.toggle("price-up", liveEntryDirection === "up");
      entryV.classList.toggle("price-down", liveEntryDirection === "down");
    } else {
      entryV.textContent = "--";
      entryV.classList.remove("price-up", "price-down", "price-ticker");
    }
    liqV.textContent = Number.isFinite(p.liq) ? fmt(p.liq, 2) : "--";

    if (Number.isFinite(p.feeUsd)) {
      const ratePct = (p.feeRate * 100);
      feeV.textContent = `${ratePct.toFixed(2)}% (${fmtUsd(p.feeUsd)})`;
    } else feeV.textContent = "--";

    impactV.textContent = Number.isFinite(p.impactPct) ? `${(p.impactPct * 100).toFixed(2)}%` : "--";

    if (state.reduceOnly) {
      marginK.textContent = "Receive";
      marginV.textContent = Number.isFinite(p.marginUsed) ? fmtUsd(p.marginUsed) : "--";
    } else {
      marginK.textContent = "Margin Used";
      marginV.textContent = Number.isFinite(p.marginUsed) ? fmtUsd(p.marginUsed) : "--";
    }


    /* Liquidation Protection render */
    // Show preview when opening (no position OR not reduce-only close intent)
    // Show countdown when protection active and time remaining > 0
    if (protBanner){
      const rem = remainingProtectionMs();
      const showPreview = !position.hasPosition;
      const showActive = position.hasPosition && position.protection.active && rem > 0;

      if (showPreview){
        protBanner.classList.remove("hidden");
        protTitle.textContent = "Liquidation Protection · 15 min";
        protSub.textContent = "No liquidation during the first 15 minutes after opening";
        protRight.textContent = "15 min";
        protRight.classList.remove("active");
      } else if (showActive){
        protBanner.classList.remove("hidden");
        protTitle.textContent = "Liquidation Protection";
        protSub.textContent = "No liquidation during the first 15 minutes after opening";
        protRight.textContent = fmtMMSS(rem);
        protRight.classList.add("active");
      } else {
        protBanner.classList.add("hidden");
      }
    }

        submitBtn.classList.toggle("buy", state.side === "buy");
    submitBtn.classList.toggle("sell", state.side === "sell");

    // CTA label logic:
    // - Market tab: Place Buy/Long or Place Sell/Short
    // - Limit tab: Trigger-order semantics (Stop/Limit) for opens, TP/SL for reduce-only closes
    const O = market.oraclePrice;
    const P = Number.isFinite(state.limitPrice) ? state.limitPrice : O;
    const eps = 0.01;

    function limitCtaLabel(){
      const dir = sideToDir(); // "long" | "short"
      const above = P > O + eps;
      const below = P < O - eps;

      // Reduce-only: interpret as closing based on current side selection (TP/SL)
      if (state.reduceOnly) {
        if (!position.hasPosition) return "Place Close";
        if (!above && !below) return "Place Close";

        if (dir === "long") return above ? "Place TP" : "Place SL";
        // dir === "short"
        return below ? "Place TP" : "Place SL";
      }

      // Not reduce-only: interpret as opening trigger order (Stop vs Limit)
      if (!above && !below) return "Place Market";

      if (dir === "long") {
        return above ? "Place Stop Market" : "Place Limit";
      }
      // dir === "short"
      return below ? "Place Stop Market" : "Place Limit";
    }

    submitBtn.textContent = state.tab === "limit"
      ? limitCtaLabel()
      : (state.side === "buy" ? "Place Buy / Long" : "Place Sell / Short");

    let err = null;
    if (state.size > 0 && Number.isFinite(p.marginUsed) && p.marginUsed > wallet.availableUSDC) {
      err = "Insufficient available balance for this margin";
    }
    sizeErr.style.display = err ? "block" : "none";
    sizeErr.textContent = err || "";
    submitBtn.disabled = !!err || !(state.size > 0);
  }

  if (priceFeed && typeof priceFeed.subscribe === "function") {
    priceFeed.subscribe(({price, direction}) => {
      if (!Number.isFinite(price)) return;
      liveEntryPrice = price;
      if (direction) liveEntryDirection = direction;
      market.oraclePrice = price;
      bumpEntryTicker();
      render();
    });
  }

  if (priceFeed && typeof priceFeed.subscribe === "function") {
    priceFeed.subscribe(({price, direction}) => {
      if (!Number.isFinite(price)) return;
      liveEntryPrice = price;
      if (direction) liveEntryDirection = direction;
      market.oraclePrice = price;
      bumpEntryTicker();
      render();
    });
  }

  // Tabs
  tabs.addEventListener("click", (e) => {
    const t = e.target.closest(".tab");
    if (!t) return;
    state.tab = t.dataset.tab;
    render();
  });

// Side (keep reduce-only unchanged across Buy/Long ↔ Sell/Short switches)
sideSeg.addEventListener("click", (e) => {
  const b = e.target.closest("button");
  if (!b) return;
  const nextSide = b.dataset.side;
  if (nextSide === state.side) return;

  state.side = nextSide;

  // IMPORTANT: reduce-only should remain as-is (no auto flip)
  // Still clamp size because max size may depend on direction/entry
  clampSizeIfNeeded();
  render();
});

  // Size
  size.addEventListener("input", () => {
    state.size = Number(size.value || 0);
    render();
  });

  // Unit
  sizeUnit.addEventListener("change", () => {
    state.unit = sizeUnit.value;
    size.step = state.unit === "ETH" ? "0.0001" : "0.01";
    clampSizeIfNeeded();
    render();
  });

  // NEW: quick buttons
  let _flashTimer = null;
  sizeQuick.addEventListener("click", (e) => {
    const btn = e.target.closest("button[data-p]");
    if (!btn) return;

    // transient active
    if (_flashTimer) clearTimeout(_flashTimer);
    sizeQuick.querySelectorAll("button.flash").forEach(b => b.classList.remove("flash"));

    // reflow to restart animation even if clicking same button repeatedly
    void btn.offsetWidth;

    btn.classList.add("flash");
    _flashTimer = setTimeout(() => btn.classList.remove("flash"), 500);

    const p = Number(btn.dataset.p);
    setSizeFromPct(p);
  });

  // Leverage
  lev.addEventListener("input", () => {
    state.lev = Number(lev.value);
    clampSizeIfNeeded();
    render();
  });

  function snapNow(){
    const raw = Number(lev.value);
    const snapped = nearestSnapLev(raw);
    if (snapped !== raw) {
      lev.value = String(snapped);
      state.lev = snapped;
      clampSizeIfNeeded();
      render();
    }
  }
  lev.addEventListener("change", snapNow);
  lev.addEventListener("pointerup", snapNow);
  lev.addEventListener("touchend", snapNow);
  lev.addEventListener("mouseup", snapNow);
  lev.addEventListener("keyup", (e) => { if (e.key === "Enter") snapNow(); });

  // Limit price
  limitPrice.addEventListener("input", () => {
    const v = Number(limitPrice.value);
    state.limitPrice = Number.isFinite(v) && v > 0 ? v : null;
    render();
  });

  // Reduce-only manual override
  function toggleReduce(){
    if (!position.hasPosition) return;
    state.reduceOnly = !state.reduceOnly;
    state.reduceOnlyManual = true;

    clampSizeIfNeeded();
    render();
  }
  reduceToggle.addEventListener("click", toggleReduce);
  reduceToggle.addEventListener("keydown", (e) => {
    if (e.key === "Enter" || e.key === " ") { e.preventDefault(); toggleReduce(); }
  });

  // TP/SL
  tpslMini.addEventListener("click", () => {
    if (state.reduceOnly) return; // block when reduce-only
    if (!state.tpslEnabled) { state.tpslEnabled = true; state.tpslOpen = true; }
    else { state.tpslOpen = !state.tpslOpen; }
    render();
  });

  tp.addEventListener("input", () => {
    const v = Number(tp.value);
    state.tp = Number.isFinite(v) && v > 0 ? v : null;
    render();
  });

  sl.addEventListener("input", () => {
    const v = Number(sl.value);
    state.sl = Number.isFinite(v) && v > 0 ? v : null;
    render();
  });

  // Slippage edit (Enter apply, Esc rollback)
  function openSlipEdit(){
    state._slipDraftPrev = state.slippagePct;
    slipInput.value = state.slippagePct.toFixed(2);
    slipValue.classList.add("hidden");
    slipEditor.classList.remove("hidden");
    slipInput.focus();
    slipInput.select();
  }
  function closeSlipEdit(apply){
    if (apply) {
      const v = Number(slipInput.value);
      if (Number.isFinite(v) && v >= 0) state.slippagePct = Math.min(50, v);
    } else {
      if (Number.isFinite(state._slipDraftPrev)) state.slippagePct = state._slipDraftPrev;
    }
    state._slipDraftPrev = null;
    slipEditor.classList.add("hidden");
    slipValue.classList.remove("hidden");
    render();
  }

  slipValue.addEventListener("click", () => {
    if (state.tab === "limit") return;
    openSlipEdit();
  });
  slipInput.addEventListener("keydown", (e) => {
    if (e.key === "Enter") closeSlipEdit(true);
    if (e.key === "Escape") closeSlipEdit(false);
  });
  slipInput.addEventListener("blur", () => closeSlipEdit(true));

  // CTA

  submitBtn.addEventListener("click", () => {
    /* simulate position + protection (prototype only)
       - Open / increase (NOT reduce-only): start 15m protection
       - Reduce-only: if size closes the position, clear protection and reset to preview
    */
    const p = computePreview();
    const dir = sideToDir();

    if (state.reduceOnly && position.hasPosition) {
      // naive "close if size >= position" rule for prototype
      let close = false;
      if (state.unit === "ETH") close = state.size >= position.sizeEth - 1e-9;
      else close = state.size >= (position.sizeEth * market.oraclePrice) - 1e-6;

      if (close) {
        position.hasPosition = false;
        clearProtection();
        state.reduceOnly = false;
        state.reduceOnlyManual = false;
        render();
      }
    } else {
      // opening / increasing
      position.hasPosition = true;
      position.side = dir;
      startProtection();
      render();
    }


    // p already computed above
    alert("Order payload (prototype):\n\n" + JSON.stringify({
      type: state.tab,
      side: state.side,
      direction: sideToDir(),
      size: state.size,
      sizeUnit: state.unit,
      leverage: state.lev,
      reduceOnly: state.reduceOnly,
      reduceOnlyManual: state.reduceOnlyManual,
      limitPrice: state.tab === "limit" ? state.limitPrice : undefined,
      slippagePct: state.slippagePct,
      tp: state.tpslEnabled ? state.tp : undefined,
      sl: state.tpslEnabled ? state.sl : undefined,
      orderValueUSDC: p.orderValue,
      estimatedEntry: p.entry,
      priceImpactPct: p.impactPct,
      liquidation: p.liq,
      feeRate: market.feeRate,
      feeUsd: p.feeUsd,
      marginUsed: p.marginUsed,
      currentPosition: position.hasPosition ? { side: position.side, sizeEth: position.sizeEth } : null,
      available: wallet.availableUSDC
    }, null, 2));
  });


  // Protection countdown ticker (only triggers re-render when active)
  setInterval(() => {
    if (position.hasPosition && position.protection.active) {
      const rem = remainingProtectionMs();
      if (rem <= 0) {
        // expired; hide banner naturally
        position.protection.active = false;
      }
      render();
    }
  }, 1000);

  // Init
  applyAutoReduceOnly("directionChanged");
  render();
})();
</script>

<script>
(() => {
  // Mock data (replace with real)
  const market = { oraclePrice: 4302.15, feeRate: 0.0005, maxLev: 25 };
  const wallet = { availableUSDC: 1000 };

  const position = {
    hasPosition: false,
    side: "long",      // "long" | "short"
    sizeEth: 0.1000,
  

    // Liquidation Protection: granted on open, lasts 15 minutes
    protection: {
      active: false,
      endTime: 0
    }
  };

  const state = {
    tab: "market",
    side: "buy",       // "buy" | "sell"
    size: 0,
    unit: "ETH",
    lev: 5,
    limitPrice: null,

    reduceOnly: false,
    reduceOnlyManual: false,

    slippagePct: 0.30,
    _slipDraftPrev: null,

    tpslEnabled: false,
    tpslOpen: false,
    tp: null,
    sl: null
  };

  const SNAP_LEV = [1, 5, 10, 25];

  const $ = (id) => document.getElementById(id);

  const availV = $("availV");
  const tabs = $("tabs");
  const sideSeg = $("sideSeg");

  const size = $("size");
  const sizeUnit = $("sizeUnit");
  const sizeQuick = $("sizeQuick"); // NEW

  const reduceRow = $("reduceRow");
  const reduceToggle = $("reduceToggle");
  const posValue = $("posValue");

  const lev = $("lev");
  const levPill = $("levPill");
  const levFill = $("levFill");
  const levKnob = $("levKnob");

  const limitCard = $("limitCard");
  const limitPrice = $("limitPrice");

  const tpslCard = $("tpslCard");
  const tpslMini = $("tpslMini");
  const tpslBody = $("tpslBody");
  const tpslSummary = $("tpslSummary");
  const tp = $("tp");
  const sl = $("sl");
  const tpPct = $("tpPct");
  const slPct = $("slPct");

  const sizeErr = $("sizeErr");

  const orderValueV = $("orderValueV");
  const entryV = $("entryV");
  const liqV = $("liqV");
  const feeV = $("feeV");
  const impactV = $("impactV");
  const marginV = $("marginV");
  const levBox = $("levBox");
  const marginK = $("marginK");
  const entryRow = $("entryRow");
  const impactRow = $("impactRow");
  const slipRow = $("slipRow");

  const slipValue = $("slipValue");
  const slipEditor = $("slipEditor");
  const slipInput = $("slipInput");

  const submitBtn = $("submitBtn");
  // Liquidation Protection elements
  const protBanner = $("protBanner");
  const protTitle = $("protTitle");
  const protSub = $("protSub");
  const protRight = $("protRight");

  const priceFeed = window.fxPriceFeed;
  let liveEntryPrice = null;
  let liveEntryDirection = "flat";
  let entryFlashTimer = null;
  function bumpEntryTicker(){
    if(!entryV) return;
    entryV.classList.add("price-ticker","price-bump");
    clearTimeout(entryFlashTimer);
    entryFlashTimer = setTimeout(() => entryV.classList.remove("price-bump"), 350);
  }

  const fmt = (n, d=2) => Number.isFinite(n)
    ? n.toLocaleString(undefined, {minimumFractionDigits:d, maximumFractionDigits:d})
    : "--";
  const fmtUsd = (n) => Number.isFinite(n)
    ? `${n.toLocaleString(undefined, {minimumFractionDigits:2, maximumFractionDigits:2})} USDC`
    : "--";

  function sideToDir(){ return state.side === "buy" ? "long" : "short"; }

  function nowMs(){ return Date.now(); }
  function startProtection(){
    position.protection.active = true;
    position.protection.endTime = nowMs() + 15 * 60 * 1000;
  }
  function clearProtection(){
    position.protection.active = false;
    position.protection.endTime = 0;
  }
  function remainingProtectionMs(){
    if (!position.protection.active) return 0;
    return Math.max(0, position.protection.endTime - nowMs());
  }
  function fmtMMSS(ms){
    const s = Math.max(0, Math.floor(ms / 1000));
    const mm = String(Math.floor(s / 60)).padStart(2, "0");
    const ss = String(s % 60).padStart(2, "0");
    return `${mm}:${ss}`;
  }

  function estimateImpactPct(orderValueUsd){
    return Math.min(0.006, (orderValueUsd / 250000) * 0.0015);
  }
  function calcEstimatedEntry(dir, oracle, impactPct){
    return dir === "long" ? oracle * (1 + impactPct) : oracle * (1 - impactPct);
  }
  function calcLiquidation(entry, dir, lev){
    const k = 0.9 / Math.max(1, lev);
    return dir === "long" ? entry * (1 - k) : entry * (1 + k);
  }

  function computePreview(){
    if (!(state.size > 0)) {
      return { entry:NaN, liq:NaN, orderValue:NaN, feeUsd:NaN, feeRate:market.feeRate, impactPct:NaN, marginUsed:NaN };
    }
    const roughValue = state.unit === "USDC" ? state.size : state.size * market.oraclePrice;
    const impactPct = estimateImpactPct(roughValue);

    const dir = sideToDir();
    const entry = calcEstimatedEntry(dir, market.oraclePrice, impactPct);

    const orderValue = state.unit === "USDC" ? state.size : state.size * entry;
    const liq = calcLiquidation(entry, dir, state.lev);

    const feeUsd = orderValue * market.feeRate;
    const marginUsed = orderValue / state.lev;

    return { entry, liq, orderValue, feeUsd, feeRate:market.feeRate, impactPct, marginUsed };
  }

  // NEW: max size logic for 25/50/75/Max
  function maxSizeForUnit(p){
    // Reduce-only: cap to current position
    if (position.hasPosition && state.reduceOnly) {
      if (state.unit === "ETH") return Math.max(0, position.sizeEth);
      const px = Number.isFinite(p.entry) ? p.entry : market.oraclePrice;
      return Math.max(0, position.sizeEth * px);
    }

    // Normal: max order value = available * leverage
    const maxOrderValueUSDC = wallet.availableUSDC * state.lev;

    if (state.unit === "USDC") return Math.max(0, maxOrderValueUSDC);

    const px = Number.isFinite(p.entry) ? p.entry : market.oraclePrice;
    return px > 0 ? Math.max(0, maxOrderValueUSDC / px) : 0;
  }

  function setSizeFromPct(pct){
    // Use current preview to get a reasonable entry
    const p = computePreview();
    const max = maxSizeForUnit(p);
    const next = max * pct;

    state.size = next;
    const d = (state.unit === "ETH") ? 4 : 2;
    size.value = next ? next.toFixed(d) : "";

    // feel: keep focus on Size
    size.focus();
    render();
  }

  function pctFromPrice(targetPrice, entry, dir){
    if (!Number.isFinite(targetPrice) || !(targetPrice > 0) || !Number.isFinite(entry) || !(entry > 0)) return null;
    const raw = (targetPrice / entry - 1) * 100;
    if (dir === "short") return -raw;
    return raw;
  }

  function setLevVisual(){
    const pct = (state.lev - 1) / (market.maxLev - 1);
    const x = Math.round(pct * 1000) / 10; // 0.1%
    levFill.style.width = `${x}%`;
    levKnob.style.left = `${x}%`;
  }

  function nearestSnapLev(v){
    let best = SNAP_LEV[0];
    let bestD = Math.abs(v - best);
    for (const p of SNAP_LEV) {
      const d = Math.abs(v - p);
      if (d < bestD) { bestD = d; best = p; }
    }
    return (bestD <= 2) ? best : v;
  }

  function applyAutoReduceOnly(reason){
    if (!position.hasPosition) {
      state.reduceOnly = false;
      state.reduceOnlyManual = false;
      return;
    }
    const dir = sideToDir();
    const opposite = (position.side === "long" && dir === "short") || (position.side === "short" && dir === "long");

    if (reason === "directionChanged") {
      state.reduceOnlyManual = false;
      state.reduceOnly = opposite;
      return;
    }
    if (!state.reduceOnlyManual) state.reduceOnly = opposite;
  }

  function clampSizeIfNeeded(){
    if (!(state.size > 0)) return;
    const p = computePreview();
    const max = maxSizeForUnit(p);
    if (Number.isFinite(max) && max >= 0 && state.size > max) {
      state.size = max;
      const d = (state.unit === "ETH") ? 4 : 2;
      size.value = max ? max.toFixed(d) : "";
    }
  }

  function render(){
    availV.textContent = fmtUsd(wallet.availableUSDC);

    [...tabs.querySelectorAll(".tab")].forEach(t => t.classList.toggle("on", t.dataset.tab === state.tab));
    [...sideSeg.querySelectorAll("button")].forEach(b => {
      const on = b.dataset.side === state.side;
      b.classList.toggle("on", on);
      b.classList.toggle("buy", b.dataset.side === "buy");
      b.classList.toggle("sell", b.dataset.side === "sell");
    });

    if (state.tab === "limit") {
      limitCard.classList.remove("hidden");
      if (!(Number.isFinite(state.limitPrice) && state.limitPrice > 0)) {
        state.limitPrice = market.oraclePrice;
        limitPrice.value = String(market.oraclePrice.toFixed(2));
      }
    } else {
      limitCard.classList.add("hidden");
    }

    // Limit mode: hide slippage / estimated entry / price impact (oracle trigger -> market exec)
    const isLimit = state.tab === "limit";
    entryRow.classList.toggle("hiddenRow", isLimit);
    impactRow.classList.toggle("hiddenRow", isLimit);
    slipRow.classList.toggle("hiddenRow", isLimit);

    if (position.hasPosition) {
      reduceRow.classList.remove("hidden");
      posValue.textContent = `${position.sizeEth.toFixed(4)} ETH`;
      reduceToggle.classList.toggle("on", state.reduceOnly);
      reduceToggle.setAttribute("aria-checked", String(state.reduceOnly));
      // Reduce-only UX: hide leverage section (no leverage changes when reducing)
      levBox.classList.toggle("hidden", !!state.reduceOnly);
    } else {
      reduceRow.classList.add("hidden");
      state.reduceOnly = false;
      state.reduceOnlyManual = false;
      levBox.classList.remove("hidden");
    }

    levPill.textContent = `${state.lev}x`;
    setLevVisual();

    slipValue.textContent = `${state.slippagePct.toFixed(2)}%`;

    const p = computePreview();
    const dir = sideToDir();

    // Hide TP/SL when reduce-only is on
    const hideTpsl = !!state.reduceOnly;
    tpslCard.classList.toggle("hidden", hideTpsl);
    if (hideTpsl) {
      state.tpslEnabled = false;
      state.tpslOpen = false;
      state.tp = null;
      state.sl = null;
    }

    // TP/SL
    tpslMini.classList.toggle("on", state.tpslEnabled);
    tpslMini.classList.toggle("open", state.tpslOpen);
    tpslBody.classList.toggle("open", state.tpslOpen);

    if (!state.tpslEnabled) {
      tpslSummary.textContent = "TP/SL · Off";
      tpPct.textContent = "—"; slPct.textContent = "—";
      tpPct.className = "inlinePct mutedPct";
      slPct.className = "inlinePct mutedPct";
    } else {
      const tpTxt = Number.isFinite(state.tp) ? fmt(state.tp, 2) : "—";
      const slTxt = Number.isFinite(state.sl) ? fmt(state.sl, 2) : "—";
      if (Number.isFinite(state.tp) || Number.isFinite(state.sl)) {
        const parts = [];
        if (Number.isFinite(state.tp)) parts.push(`TP ${tpTxt}`);
        if (Number.isFinite(state.sl)) parts.push(`SL ${slTxt}`);
        tpslSummary.textContent = parts.join(" / ");
      } else {
        tpslSummary.textContent = "TP/SL · On";
      }

      const tpP = pctFromPrice(state.tp, p.entry, dir);
      const slP = pctFromPrice(state.sl, p.entry, dir);

      if (tpP === null) { tpPct.textContent="—"; tpPct.className="inlinePct mutedPct"; }
      else {
        const s = tpP >= 0 ? "+" : "";
        tpPct.textContent = `${s}${tpP.toFixed(2)}%`;
        tpPct.className = `inlinePct ${tpP >= 0 ? "pos" : "neg"}`;
      }

      if (slP === null) { slPct.textContent="—"; slPct.className="inlinePct mutedPct"; }
      else {
        const s = slP >= 0 ? "+" : "";
        slPct.textContent = `${s}${slP.toFixed(2)}%`;
        slPct.className = `inlinePct ${slP >= 0 ? "pos" : "neg"}`;
      }
    }

    // Preview
    orderValueV.textContent = Number.isFinite(p.orderValue) ? fmtUsd(p.orderValue) : "--";
    const priceForEntry = Number.isFinite(liveEntryPrice) ? liveEntryPrice : p.entry;
    if (Number.isFinite(priceForEntry)) {
      entryV.textContent = fmt(priceForEntry, 2);
      entryV.classList.add("price-ticker");
      entryV.classList.toggle("price-up", liveEntryDirection === "up");
      entryV.classList.toggle("price-down", liveEntryDirection === "down");
    } else {
      entryV.textContent = "--";
      entryV.classList.remove("price-up", "price-down", "price-ticker");
    }
    liqV.textContent = Number.isFinite(p.liq) ? fmt(p.liq, 2) : "--";

    if (Number.isFinite(p.feeUsd)) {
      const ratePct = (p.feeRate * 100);
      feeV.textContent = `${ratePct.toFixed(2)}% (${fmtUsd(p.feeUsd)})`;
    } else feeV.textContent = "--";

    impactV.textContent = Number.isFinite(p.impactPct) ? `${(p.impactPct * 100).toFixed(2)}%` : "--";

    if (state.reduceOnly) {
      marginK.textContent = "Receive";
      marginV.textContent = Number.isFinite(p.marginUsed) ? fmtUsd(p.marginUsed) : "--";
    } else {
      marginK.textContent = "Margin Used";
      marginV.textContent = Number.isFinite(p.marginUsed) ? fmtUsd(p.marginUsed) : "--";
    }


    /* Liquidation Protection render */
    // Show preview when opening (no position OR not reduce-only close intent)
    // Show countdown when protection active and time remaining > 0
    if (protBanner){
      const rem = remainingProtectionMs();
      const showPreview = !position.hasPosition;
      const showActive = position.hasPosition && position.protection.active && rem > 0;

      if (showPreview){
        protBanner.classList.remove("hidden");
        protTitle.textContent = "Liquidation Protection · 15 min";
        protSub.textContent = "No liquidation during the first 15 minutes after opening";
        protRight.textContent = "15 min";
        protRight.classList.remove("active");
      } else if (showActive){
        protBanner.classList.remove("hidden");
        protTitle.textContent = "Liquidation Protection";
        protSub.textContent = "No liquidation during the first 15 minutes after opening";
        protRight.textContent = fmtMMSS(rem);
        protRight.classList.add("active");
      } else {
        protBanner.classList.add("hidden");
      }
    }

        submitBtn.classList.toggle("buy", state.side === "buy");
    submitBtn.classList.toggle("sell", state.side === "sell");

    // CTA label logic:
    // - Market tab: Place Buy/Long or Place Sell/Short
    // - Limit tab: Trigger-order semantics (Stop/Limit) for opens, TP/SL for reduce-only closes
    const O = market.oraclePrice;
    const P = Number.isFinite(state.limitPrice) ? state.limitPrice : O;
    const eps = 0.01;

    function limitCtaLabel(){
      const dir = sideToDir(); // "long" | "short"
      const above = P > O + eps;
      const below = P < O - eps;

      // Reduce-only: interpret as closing based on current side selection (TP/SL)
      if (state.reduceOnly) {
        if (!position.hasPosition) return "Place Close";
        if (!above && !below) return "Place Close";

        if (dir === "long") return above ? "Place TP" : "Place SL";
        // dir === "short"
        return below ? "Place TP" : "Place SL";
      }

      // Not reduce-only: interpret as opening trigger order (Stop vs Limit)
      if (!above && !below) return "Place Market";

      if (dir === "long") {
        return above ? "Place Stop Market" : "Place Limit";
      }
      // dir === "short"
      return below ? "Place Stop Market" : "Place Limit";
    }

    submitBtn.textContent = state.tab === "limit"
      ? limitCtaLabel()
      : (state.side === "buy" ? "Place Buy / Long" : "Place Sell / Short");

    let err = null;
    if (state.size > 0 && Number.isFinite(p.marginUsed) && p.marginUsed > wallet.availableUSDC) {
      err = "Insufficient available balance for this margin";
    }
    sizeErr.style.display = err ? "block" : "none";
    sizeErr.textContent = err || "";
    submitBtn.disabled = !!err || !(state.size > 0);
  }

  // Tabs
  tabs.addEventListener("click", (e) => {
    const t = e.target.closest(".tab");
    if (!t) return;
    state.tab = t.dataset.tab;
    render();
  });

// Side (keep reduce-only unchanged across Buy/Long ↔ Sell/Short switches)
sideSeg.addEventListener("click", (e) => {
  const b = e.target.closest("button");
  if (!b) return;
  const nextSide = b.dataset.side;
  if (nextSide === state.side) return;

  state.side = nextSide;

  // IMPORTANT: reduce-only should remain as-is (no auto flip)
  // Still clamp size because max size may depend on direction/entry
  clampSizeIfNeeded();
  render();
});

  // Size
  size.addEventListener("input", () => {
    state.size = Number(size.value || 0);
    render();
  });

  // Unit
  sizeUnit.addEventListener("change", () => {
    state.unit = sizeUnit.value;
    size.step = state.unit === "ETH" ? "0.0001" : "0.01";
    clampSizeIfNeeded();
    render();
  });

  // NEW: quick buttons
  let _flashTimer = null;
  sizeQuick.addEventListener("click", (e) => {
    const btn = e.target.closest("button[data-p]");
    if (!btn) return;

    // transient active
    if (_flashTimer) clearTimeout(_flashTimer);
    sizeQuick.querySelectorAll("button.flash").forEach(b => b.classList.remove("flash"));

    // reflow to restart animation even if clicking same button repeatedly
    void btn.offsetWidth;

    btn.classList.add("flash");
    _flashTimer = setTimeout(() => btn.classList.remove("flash"), 500);

    const p = Number(btn.dataset.p);
    setSizeFromPct(p);
  });

  // Leverage
  lev.addEventListener("input", () => {
    state.lev = Number(lev.value);
    clampSizeIfNeeded();
    render();
  });

  function snapNow(){
    const raw = Number(lev.value);
    const snapped = nearestSnapLev(raw);
    if (snapped !== raw) {
      lev.value = String(snapped);
      state.lev = snapped;
      clampSizeIfNeeded();
      render();
    }
  }
  lev.addEventListener("change", snapNow);
  lev.addEventListener("pointerup", snapNow);
  lev.addEventListener("touchend", snapNow);
  lev.addEventListener("mouseup", snapNow);
  lev.addEventListener("keyup", (e) => { if (e.key === "Enter") snapNow(); });

  // Limit price
  limitPrice.addEventListener("input", () => {
    const v = Number(limitPrice.value);
    state.limitPrice = Number.isFinite(v) && v > 0 ? v : null;
    render();
  });

  // Reduce-only manual override
  function toggleReduce(){
    if (!position.hasPosition) return;
    state.reduceOnly = !state.reduceOnly;
    state.reduceOnlyManual = true;

    clampSizeIfNeeded();
    render();
  }
  reduceToggle.addEventListener("click", toggleReduce);
  reduceToggle.addEventListener("keydown", (e) => {
    if (e.key === "Enter" || e.key === " ") { e.preventDefault(); toggleReduce(); }
  });

  // TP/SL
  tpslMini.addEventListener("click", () => {
    if (state.reduceOnly) return; // block when reduce-only
    if (!state.tpslEnabled) { state.tpslEnabled = true; state.tpslOpen = true; }
    else { state.tpslOpen = !state.tpslOpen; }
    render();
  });

  tp.addEventListener("input", () => {
    const v = Number(tp.value);
    state.tp = Number.isFinite(v) && v > 0 ? v : null;
    render();
  });

  sl.addEventListener("input", () => {
    const v = Number(sl.value);
    state.sl = Number.isFinite(v) && v > 0 ? v : null;
    render();
  });

  // Slippage edit (Enter apply, Esc rollback)
  function openSlipEdit(){
    state._slipDraftPrev = state.slippagePct;
    slipInput.value = state.slippagePct.toFixed(2);
    slipValue.classList.add("hidden");
    slipEditor.classList.remove("hidden");
    slipInput.focus();
    slipInput.select();
  }
  function closeSlipEdit(apply){
    if (apply) {
      const v = Number(slipInput.value);
      if (Number.isFinite(v) && v >= 0) state.slippagePct = Math.min(50, v);
    } else {
      if (Number.isFinite(state._slipDraftPrev)) state.slippagePct = state._slipDraftPrev;
    }
    state._slipDraftPrev = null;
    slipEditor.classList.add("hidden");
    slipValue.classList.remove("hidden");
    render();
  }

  slipValue.addEventListener("click", () => {
    if (state.tab === "limit") return;
    openSlipEdit();
  });
  slipInput.addEventListener("keydown", (e) => {
    if (e.key === "Enter") closeSlipEdit(true);
    if (e.key === "Escape") closeSlipEdit(false);
  });
  slipInput.addEventListener("blur", () => closeSlipEdit(true));

  // CTA

  submitBtn.addEventListener("click", () => {
    /* simulate position + protection (prototype only)
       - Open / increase (NOT reduce-only): start 15m protection
       - Reduce-only: if size closes the position, clear protection and reset to preview
    */
    const p = computePreview();
    const dir = sideToDir();

    if (state.reduceOnly && position.hasPosition) {
      // naive "close if size >= position" rule for prototype
      let close = false;
      if (state.unit === "ETH") close = state.size >= position.sizeEth - 1e-9;
      else close = state.size >= (position.sizeEth * market.oraclePrice) - 1e-6;

      if (close) {
        position.hasPosition = false;
        clearProtection();
        state.reduceOnly = false;
        state.reduceOnlyManual = false;
        render();
      }
    } else {
      // opening / increasing
      position.hasPosition = true;
      position.side = dir;
      startProtection();
      render();
    }


    // p already computed above
    alert("Order payload (prototype):\n\n" + JSON.stringify({
      type: state.tab,
      side: state.side,
      direction: sideToDir(),
      size: state.size,
      sizeUnit: state.unit,
      leverage: state.lev,
      reduceOnly: state.reduceOnly,
      reduceOnlyManual: state.reduceOnlyManual,
      limitPrice: state.tab === "limit" ? state.limitPrice : undefined,
      slippagePct: state.slippagePct,
      tp: state.tpslEnabled ? state.tp : undefined,
      sl: state.tpslEnabled ? state.sl : undefined,
      orderValueUSDC: p.orderValue,
      estimatedEntry: p.entry,
      priceImpactPct: p.impactPct,
      liquidation: p.liq,
      feeRate: market.feeRate,
      feeUsd: p.feeUsd,
      marginUsed: p.marginUsed,
      currentPosition: position.hasPosition ? { side: position.side, sizeEth: position.sizeEth } : null,
      available: wallet.availableUSDC
    }, null, 2));
  });


  // Protection countdown ticker (only triggers re-render when active)
  setInterval(() => {
    if (position.hasPosition && position.protection.active) {
      const rem = remainingProtectionMs();
      if (rem <= 0) {
        // expired; hide banner naturally
        position.protection.active = false;
      }
      render();
    }
  }, 1000);

  // Init
  applyAutoReduceOnly("directionChanged");
  render();
})();
</script>

<script>
(() => {
  // ===== Bottom panel mock data (V1) =====
  // Status meanings:
  // - Open: waiting for trigger
  // - Triggered: trigger condition met, submitted to market-execute (Oracle ± Impact)
  // - Filled: executed
  // - Cancelled / Expired: no longer active
  // - No Position: reduce-only order but there is no open position (would be auto-cancelled)

  const fmtNum = (n, d=2) => {
    const x = Number(n);
    if (!isFinite(x)) return "—";
    return x.toLocaleString(undefined, {minimumFractionDigits:d, maximumFractionDigits:d});
  };
  const parseEth = (s) => {
    if (!s) return NaN;
    const m = String(s).replace(/,/g,'').match(/([0-9]*\.?[0-9]+)/);
    return m ? Number(m[1]) : NaN;
  };
  const parseUsd = (s) => {
    if (!s) return NaN;
    const m = String(s).replace(/,/g,'').match(/-?\$?([0-9]*\.?[0-9]+)/);
    return m ? Number(m[1]) : NaN;
  };

  const oracleNow = 4302.15;

  const data = {
    positions: [
      {
        coin:"ETH", lev:"3x",
        side:"Long",
        size:"0.1000 ETH",
        entry:"4,000.0",
        oracle: fmtNum(oracleNow, 2),
        pnl:"-$88.30 (-44.2%)",
        liq:"5,076.53",
        marginUsed:"$155.85 (Isolated)",
        funding:"-$8.05",
      },
      {
        coin:"ETH", lev:"5x",
        side:"Short",
        size:"0.0700 ETH",
        entry:"4,400.0",
        oracle: fmtNum(oracleNow, 2),
        pnl:"+$6.85 (+12.3%)",
        liq:"4,988.10",
        marginUsed:"$55.60 (Isolated)",
        funding:"+$0.92",
      },
    ],
    orders: [
      // Long (open)
      { time:"2026/1/8 22:35:09", type:"Limit (Trigger)", coin:"ETH", dir:"Long", size:"0.0953", val:"285.90 USDC", trig:"3,000.0", ro:"No", cond:"Trigger: Oracle ≤ 3,000", status:"Open" },
      { time:"2026/1/7 22:26:18", type:"Stop Market (Trigger)", coin:"ETH", dir:"Long", size:"0.0717", val:"215.10 USDC", trig:"3,900.0", ro:"No", cond:"Trigger: Oracle ≥ 3,900", status:"Open" },

      // Long (close / reduce-only)
      { time:"2026/1/7 21:49:29", type:"Take Profit (Trigger)", coin:"ETH", dir:"Close Long", size:"0.0500", val:"Market", trig:"4,100.0", ro:"Yes", cond:"Trigger: Oracle ≥ 4,100", status:"Open" },
      { time:"2026/1/7 21:49:31", type:"Stop Loss (Trigger)", coin:"ETH", dir:"Close Long", size:"0.0500", val:"Market", trig:"3,600.0", ro:"Yes", cond:"Trigger: Oracle ≤ 3,600", status:"Open" },

      // Short (open)
      { time:"2026/1/7 22:20:09", type:"Limit (Trigger)", coin:"ETH", dir:"Short", size:"0.0900", val:"285.90 USDC", trig:"4,250.0", ro:"No", cond:"Trigger: Oracle ≥ 4,250", status:"Open" },
      { time:"2026/1/7 22:16:53", type:"Stop Market (Trigger)", coin:"ETH", dir:"Short", size:"0.0600", val:"Market", trig:"3,900.0", ro:"No", cond:"Trigger: Oracle ≤ 3,900", status:"Open" },

      // Short (close / reduce-only)
      { time:"2026/1/7 22:43:31", type:"Take Profit (Trigger)", coin:"ETH", dir:"Close Short", size:"0.0717", val:"Market", trig:"2,900.0", ro:"Yes", cond:"Trigger: Oracle ≤ 2,900", status:"Open" },
      { time:"2026/1/7 22:43:33", type:"Stop Loss (Trigger)", coin:"ETH", dir:"Close Short", size:"0.0717", val:"Market", trig:"4,000.0", ro:"Yes", cond:"Trigger: Oracle ≥ 4,000", status:"Open" },
    ],
    trades: [
      { time:"2026/1/8 14:02:20", tx:"#", coin:"ETH", dir:"Open Long", price:"4,000.0", size:"0.1000 ETH", val:"400.00 USDC", fee:"0.06 USDC", pnl:"-0.06 USDC" },
      { time:"2026/1/8 14:10:18", tx:"#", coin:"ETH", dir:"Close Long", price:"4,083.8", size:"0.0430 ETH", val:"175.60 USDC", fee:"0.08 USDC", pnl:"-7.26 USDC" },
      { time:"2026/1/8 14:20:11", tx:"#", coin:"ETH", dir:"Open Short", price:"4,400.0", size:"0.0700 ETH", val:"308.00 USDC", fee:"0.05 USDC", pnl:"-0.05 USDC" },
      { time:"2026/1/8 15:02:31", tx:"#", coin:"ETH", dir:"Close Short", price:"4,302.1", size:"0.0700 ETH", val:"301.15 USDC", fee:"0.05 USDC", pnl:"+6.85 USDC" },
    ],
    funding: [
      { time:"2026/1/9 10:00:00", coin:"ETH", size:"0.1000 ETH", side:"Long", pay:"-$0.0039", rate:"0.0013%" },
      { time:"2026/1/9 09:00:00", coin:"ETH", size:"0.1000 ETH", side:"Long", pay:"-$0.0039", rate:"0.0013%" },
      { time:"2026/1/9 08:00:00", coin:"ETH", size:"0.0700 ETH", side:"Short", pay:"+$0.0011", rate:"0.0013%" },
    ],
    history: [
      { time:"2026/1/8 22:35:09", tx:"#", type:"Limit (Trigger)", coin:"ETH", dir:"Long", size:"0.0953", filled:"—", val:"285.90 USDC", trig:"Trigger: Oracle ≤ 3,000", ro:"No", status:"Open" },
      { time:"2026/1/7 22:26:18", tx:"#", type:"Stop Market (Trigger)", coin:"ETH", dir:"Long", size:"0.0717", filled:"—", val:"Market", trig:"Trigger: Oracle ≥ 3,900", ro:"No", status:"Open" },
      { time:"2026/1/7 22:43:31", tx:"#", type:"Take Profit (Trigger)", coin:"ETH", dir:"Close Short", size:"0.0717", filled:"—", val:"Market", trig:"Trigger: Oracle ≤ 2,900", ro:"Yes", status:"Open" },
      { time:"2026/1/7 21:49:31", tx:"#", type:"Stop Loss (Trigger)", coin:"ETH", dir:"Close Long", size:"0.0500", filled:"—", val:"Market", trig:"Trigger: Oracle ≤ 3,600", ro:"Yes", status:"Open" },
    ],
  };

  const priceFeed = window.fxPriceFeed;
  let livePrice = (priceFeed && typeof priceFeed.getPrice === "function") ? priceFeed.getPrice() : null;

  // Expose demo data for external modules (positions actions modals)
  window.__fx100Data = data;


  const els = {
    tabs: document.querySelectorAll('.bottom-tabs .tab'),
    tools: document.querySelector('.bottom-tools'),
    tables: {
      positions: document.getElementById('tablePositions'),
      orders: document.getElementById('tableOrders'),
      trades: document.getElementById('tableTrades'),
      funding: document.getElementById('tableFunding'),
      history: document.getElementById('tableHistory'),
    },
    bodies: {
      pos: document.getElementById('posBody'),
      ord: document.getElementById('ordBody'),
      trd: document.getElementById('trdBody'),
      fund: document.getElementById('fundBody'),
      hist: document.getElementById('histBody'),
    },
    filterDrop: document.getElementById('filterDrop'),
    filterLabel: document.getElementById('filterLabel'),
    cancelAll: document.getElementById('cancelAllBtn'),
  };

  let currentTab = 'positions';
  let currentFilter = 'all';

  if (priceFeed && typeof priceFeed.subscribe === "function") {
    priceFeed.subscribe(({price}) => {
      if (!Number.isFinite(price)) return;
      livePrice = price;
      if (currentTab === 'positions') renderPositions();
    });
  }

  function clear(tbody){ while(tbody.firstChild) tbody.removeChild(tbody.firstChild); }
  function row(inner){
    const tr = document.createElement('tr');
    tr.innerHTML = inner;
    return tr;
  }

  function applyFilter(list){
    if(currentFilter === 'all') return list;
    if(currentFilter === 'long') return list.filter(x => (x.side ?? x.dir ?? "").toLowerCase().includes('long'));
    if(currentFilter === 'short') return list.filter(x => (x.side ?? x.dir ?? "").toLowerCase().includes('short'));
    return list;
  }

  function renderPositions(){
    const list = applyFilter(data.positions);
    clear(els.bodies.pos);

    list.forEach(p=>{
      // compute position value = size * oracle
      const sizeEth = parseEth(p.size);
      const oracle = parseUsd(p.oracle);
      const posVal = (isFinite(sizeEth) && isFinite(oracle)) ? `${fmtNum(sizeEth*oracle, 2)}` : "—";

      // Live liquidation protection badge (from ticket prototype)
      let liqProt = p.liq ? `<div>${p.liq}</div>` : `<div>—</div>`;
      try{
        const st = window.__fx100Position;
        if(st && st.hasPosition && st.protection && st.protection.active){
          const rem = Math.max(0, (st.protection.endTime ?? 0) - Date.now());
          const mm = String(Math.floor(rem/60000)).padStart(2,'0');
          const ss = String(Math.floor((rem%60000)/1000)).padStart(2,'0');
          const low = rem < 60000;
          const badge = `<span class="badge prot-badge ${low ? "prot-low" : ""}" style="border-color:rgba(80,255,180,.25); background:rgba(80,255,180,.06); color:var(--pos);">🛡 ${mm}:${ss}</span>`;
          liqProt += `<div style="margin-top:6px;">${badge}</div>`;
        }
      }catch(e){}

      const sideLower = p.side.toLowerCase();
      const dirClass = sideLower.includes('long') ? 'dir-long' : (sideLower.includes('short') ? 'dir-short' : '');
      const pnlClass = (String(p.pnl).includes('-')) ? 'dir-short' : 'dir-long';

      const entryDisplay = Number.isFinite(livePrice) ? fmtNum(livePrice, 2) : p.entry;
      const tr = row(`
        <td><b>${p.coin}</b> <span class="chip-mini ${dirClass}">${p.lev ?? ""}</span></td>
        <td class="${dirClass}"><b>${p.side}</b></td>
        <td class="${dirClass}"><b>${p.size}</b></td>
        <td><b>${posVal}</b></td>
        <td>${entryDisplay}</td>
        <td><b>${p.oracle}</b></td>
        <td class="${pnlClass}"><b>${p.pnl}</b></td>
        <td>${liqProt}</td>
        <td>${p.marginUsed}</td>
        <td class="${String(p.funding).includes('-') ? 'dir-short' : 'dir-long'}">${p.funding}</td>
        <td class="actions">
          <span class="linklike act-close">Close</span>&nbsp;&nbsp;
          <span class="linklike act-reverse">Reverse</span>&nbsp;&nbsp;
          <span class="linklike act-tpsl">TP/SL</span>
        </td>
      `);
      tr.dataset.posIndex = String(data.positions.indexOf(p));
      els.bodies.pos.appendChild(tr);
    });
  }

  function renderOrders(){
    const list = applyFilter(data.orders);
    clear(els.bodies.ord);
    list.forEach(o=>{
      const dirLower = o.dir.toLowerCase();
      const dirClass = dirLower.includes('short') ? 'dir-short' : (dirLower.includes('long') ? 'dir-long' : '');
      const statusTitle = {
        "Open":"Waiting for trigger.",
        "Triggered":"Triggered; market-execute pending.",
        "Filled":"Executed.",
        "Cancelled":"Cancelled by user/system.",
        "Expired":"Expired.",
        "No Position":"Reduce-only but no position (auto-cancel).",
      }[o.status] ?? "";
      els.bodies.ord.appendChild(row(`
        <td>${o.time}</td>
        <td><b>${o.type}</b></td>
        <td><b>${o.coin}</b></td>
        <td class="${dirClass}"><b>${o.dir}</b></td>
        <td class="${dirClass}"><b>${o.size}</b></td>
        <td>${o.val}</td>
        <td><b>${o.trig}</b></td>
        <td>${o.ro}</td>
        <td>${o.cond}</td>
        <td title="${statusTitle}">${o.status}</td>
        <td><span class="linklike">Cancel</span></td>
      `));
    });
  }

  function renderTrades(){
    const list = data.trades;
    clear(els.bodies.trd);
    list.forEach(t=>{
      const dirLower = t.dir.toLowerCase();
      const dirClass = dirLower.includes('short') ? 'dir-short' : (dirLower.includes('long') ? 'dir-long' : '');
      const timeCell = `<span style="display:inline-flex;gap:8px;align-items:center;"><span>${t.time}</span><a class="linklike" href="${t.tx}" title="View tx" style="text-decoration:none;">↗</a></span>`;
      els.bodies.trd.appendChild(row(`
        <td>${timeCell}</td>
        <td><b>${t.coin}</b></td>
        <td class="${dirClass}"><b>${t.dir}</b></td>
        <td>${t.price}</td>
        <td class="${dirClass}"><b>${t.size}</b></td>
        <td>${t.val}</td>
        <td>${t.fee}</td>
        <td class="${String(t.pnl).includes('-') ? 'dir-short' : 'dir-long'}">${t.pnl}</td>
      `));
    });
  }

  function renderFunding(){
    const list = data.funding;
    clear(els.bodies.fund);
    list.forEach(f=>{
      els.bodies.fund.appendChild(row(`
        <td>${f.time}</td>
        <td><b>${f.coin}</b></td>
        <td>${f.size}</td>
        <td>${f.side}</td>
        <td class="${String(f.pay).includes('-') ? 'dir-short' : 'dir-long'}">${f.pay}</td>
        <td>${f.rate}</td>
      `));
    });
  }

  function renderHistory(){
    const list = data.history;
    clear(els.bodies.hist);
    list.forEach(h=>{
      const dirLower = h.dir.toLowerCase();
      const dirClass = dirLower.includes('short') ? 'dir-short' : (dirLower.includes('long') ? 'dir-long' : '');
      const timeCell = `<span style="display:inline-flex;gap:8px;align-items:center;"><span>${h.time}</span><a class="linklike" href="${h.tx}" title="View tx" style="text-decoration:none;">↗</a></span>`;
      els.bodies.hist.appendChild(row(`
        <td>${timeCell}</td>
        <td><b>${h.type}</b></td>
        <td><b>${h.coin}</b></td>
        <td class="${dirClass}"><b>${h.dir}</b></td>
        <td class="${dirClass}"><b>${h.size}</b></td>
        <td>${h.filled}</td>
        <td>${h.val}</td>
        <td>${h.trig}</td>
        <td>${h.ro}</td>
        <td>${h.status}</td>
      `));
    });
  }

  function showTab(name){
    currentTab = name;
    // tabs UI
    els.tabs.forEach(t=>{
      t.classList.toggle('active', t.dataset.tab === name);
    });
    // tables
    Object.entries(els.tables).forEach(([k, el])=>{
      el.style.display = (k === name) ? '' : 'none';
    });
    // tools visibility
    els.tools.style.display = (name === 'orders' || name === 'positions') ? 'flex' : 'none';
    if(els.cancelAll){
      els.cancelAll.style.display = name === 'orders' ? 'inline-flex' : 'none';
    }

    // render
    if(name === 'positions') renderPositions();
    if(name === 'orders') renderOrders();
    if(name === 'trades') renderTrades();
    if(name === 'funding') renderFunding();
    if(name === 'history') renderHistory();
  }

  // Tab mapping (HTML uses dataset)
  const mapTabToTable = {
    positions:'positions',
    orders:'orders',
    trades:'trades',
    funding:'funding',
    history:'history'
  };

  // events
  els.tabs.forEach(t=>{
    t.addEventListener('click', ()=>{
      const key = t.dataset.tab;
      showTab(mapTabToTable[key] ?? 'positions');
    });
  });

  if(els.filterDrop){
    els.filterDrop.addEventListener('click', ()=>{
      els.filterDrop.classList.toggle('open');
    });
    els.filterDrop.querySelectorAll('[data-filter]').forEach(item=>{
      item.addEventListener('click', (e)=>{
        e.stopPropagation();
        currentFilter = item.dataset.filter;
        els.filterLabel.textContent = item.textContent.trim();
        els.filterDrop.classList.remove('open');
        showTab(currentTab);
      });
    });
    document.addEventListener('click', (e)=>{
      if(!els.filterDrop.contains(e.target)) els.filterDrop.classList.remove('open');
    });
  }

  function runCancelAllAction(){
    if(!els.cancelAll) return;
    els.cancelAll.textContent = "Cancelling...";
    const anim = els.cancelAll.animate(
      [{transform:'scale(1)'},{transform:'scale(0.98)'},{transform:'scale(1)'}],
      {duration:180}
    );
    if(anim && anim.addEventListener){
      anim.addEventListener('finish', ()=>{ els.cancelAll.textContent = "Cancel All"; });
    }else{
      setTimeout(()=>{ els.cancelAll.textContent = "Cancel All"; }, 200);
    }
  }
  window.__fxCancelAll = runCancelAllAction;

  // Keep protection timer displayed in positions list
  setInterval(()=>{
    if(currentTab === 'positions') renderPositions();
  }, 1000);

  // init
  showTab('positions');
})();
</script>


  <!-- Market selector -->
  <div class="mkt-overlay" id="mktOverlay" aria-hidden="true"></div>
  <div class="mkt-modal" id="mktModal" role="dialog" aria-modal="true" aria-label="Market selector">
    <div class="mkt-head">
      <div class="mkt-row1">
        <input class="mkt-search" id="mktSearch" placeholder="Search" autocomplete="off" />
        <div class="mkt-toggle" role="tablist" aria-label="Search mode">
          <button type="button" id="mktStrict" class="active">Strict</button>
          <button type="button" id="mktAll">All</button>
        </div>
      </div>
      <div class="mkt-tabs" id="mktTabs">
        <button type="button" data-tab="All" class="active">All</button>
        <button type="button" data-tab="Perps">Perps</button>
        <button type="button" data-tab="Crypto">Crypto</button>
        <button type="button" data-tab="Trending">Trending</button>
        <button type="button" data-tab="Pre-launch">Pre-launch</button>
      </div>
    </div>
    <div class="mkt-body">
      <table class="mkt-table">
        <thead>
          <tr>
            <th style="width:30%">Symbol</th>
            <th style="width:14%">Last Price</th>
            <th style="width:14%">24H Change</th>
            <th style="width:12%">Funding</th>
            <th style="width:14%">Volume</th>
            <th style="width:16%">Open Interest</th>
          </tr>
        </thead>
        <tbody id="mktTbody"></tbody>
      </table>
    </div>
    <div class="mkt-foot">
      <span class="kbd"><b>⌘K</b> Open</span>
      <span class="kbd"><b>↑</b><b>↓</b> Navigate</span>
      <span class="kbd"><b>Enter</b> Select</span>
      <span class="kbd"><b>Esc</b> Close</span>
    </div>
  </div>


  <!-- ===== Positions Actions Modals ===== -->
  <div class="fx-modal-overlay" id="fxActOverlay" aria-hidden="true"></div>

  <div class="fx-modal" id="fxCloseModal" role="dialog" aria-modal="true" aria-label="Market Close">
    <div class="m-hd">
      <div class="m-title">
        <div class="t1" id="fxCloseTitle">Market Close</div>
        <div class="t2" id="fxCloseSub">Executes at Oracle ± Impact</div>
      </div>
      <div class="m-x" data-fx-close="close">✕</div>
    </div>
    <div class="m-bd">
      <div class="fx-modal-card">
        <div class="fx-row between" style="margin-bottom:12px;">
          <span class="fx-pill" id="fxCloseSidePill">Long</span>
          <span class="fx-mini">Market-execute</span>
        </div>

        <div class="field">
          <div class="inLabel">Size</div>
          <input id="fxCloseSize" type="number" inputmode="decimal" placeholder="0.0" step="0.0001"/>
          <div class="inlinePct mutedPct" id="fxCloseUnit">ETH</div>
        </div>

        <div class="fx-sliderBlock">
          <div class="fx-sliderRail">
            <div class="fx-sliderFill" id="fxClosePctFill"></div>
            <div class="fx-sliderTicks">
              <span></span><span></span><span></span><span></span><span></span>
            </div>
            <div class="fx-sliderKnob" id="fxClosePctKnob"></div>
            <input class="fx-sliderInput" id="fxClosePct" type="range" min="0" max="100" step="1" value="100" />
          </div>
          <div class="fx-sliderLabels">
            <span>0%</span>
            <span>25%</span>
            <span>50%</span>
            <span>75%</span>
            <span>100%</span>
          </div>
        </div>
      </div>
    </div>
    <div class="m-ft">
      <button class="btn" id="fxCloseSubmit">Confirm Close</button>
    </div>
  </div>

  <div class="fx-modal" id="cancelAllModal" role="dialog" aria-modal="true" aria-label="Confirm Cancel All">
    <div class="m-hd">
      <div class="m-title">
        <div class="t1">Confirm Cancel All</div>
        <div class="t2">This will cancel all your open orders.</div>
      </div>
      <div class="m-x" data-cancel-all="close">✕</div>
    </div>
    <div class="m-bd" style="gap:0;">
      <p style="margin:0; font-size:13px; color:var(--label);">
        Are you sure you want to cancel every open order?
      </p>
    </div>
    <div class="m-ft">
      <button class="btn sell" id="cancelAllConfirm">Confirm Cancel All</button>
    </div>
  </div>

  <div class="fx-modal" id="fxReverseModal" role="dialog" aria-modal="true" aria-label="Reverse Position">
    <div class="m-hd">
      <div class="m-title">
        <div class="t1" id="fxRevTitle">Reverse Position</div>
        <div class="t2">Closes current position and opens the opposite side</div>
      </div>
      <div class="m-x" data-fx-rev="close">✕</div>
    </div>
    <div class="m-bd">
      <div class="fx-modal-card">
        <div class="fx-row between" style="margin-bottom:12px;">
          <span class="fx-pill" id="fxRevFromPill">From Long</span>
          <span class="fx-pill" id="fxRevToPill">To Short</span>
        </div>

        <div class="field">
          <div class="inLabel">Size</div>
          <input id="fxRevSize" type="number" inputmode="decimal" placeholder="0.0" step="0.0001"/>
          <div class="inlinePct mutedPct" id="fxRevUnit">ETH</div>
        </div>

        <div class="fx-sliderBlock">
          <div class="fx-sliderRail">
            <div class="fx-sliderFill" id="fxRevPctFill"></div>
            <div class="fx-sliderTicks">
              <span></span><span></span><span></span><span></span><span></span>
            </div>
            <div class="fx-sliderKnob" id="fxRevPctKnob"></div>
            <input class="fx-sliderInput" id="fxRevPct" type="range" min="0" max="100" step="1" value="100" />
          </div>
          <div class="fx-sliderLabels">
            <span>0%</span>
            <span>25%</span>
            <span>50%</span>
            <span>75%</span>
            <span>100%</span>
          </div>
        </div>
      </div>
    </div>
    <div class="m-ft">
      <button class="btn" id="fxRevSubmit">Confirm Reverse</button>
    </div>
  </div>

  <div class="fx-modal" id="fxTpslModal" role="dialog" aria-modal="true" aria-label="TP/SL for Position">
    <div class="m-hd">
      <div class="m-title">
        <div class="t1" id="fxTpslTitle">TP/SL for Position</div>
        <div class="t2" id="fxTpslSub">Trigger then market-execute at Oracle ± Impact</div>
      </div>
      <div class="m-x" data-fx-tpsl="close">✕</div>
    </div>
    <div class="m-bd">
      <div class="fx-modal-card">
        <div class="fx-row between" style="margin-bottom:12px;">
          <span class="fx-pill" id="fxTpslSidePill">Long</span>
          <span class="fx-mini" id="fxTpslLock">TP/SL locked to reduce-only direction</span>
        </div>

        <div class="field">
          <div class="inLabel">Size</div>
          <input id="fxTpslSize" type="number" inputmode="decimal" placeholder="0.0" step="0.0001"/>
          <div class="inlinePct mutedPct" id="fxTpslUnit">ETH</div>
        </div>

        <div class="fx-sliderBlock">
          <div class="fx-sliderRail">
            <div class="fx-sliderFill" id="fxTpslPctFill"></div>
            <div class="fx-sliderTicks">
              <span></span><span></span><span></span><span></span><span></span>
            </div>
            <div class="fx-sliderKnob" id="fxTpslPctKnob"></div>
            <input class="fx-sliderInput" id="fxTpslPct" type="range" min="0" max="100" step="1" value="100" />
          </div>
          <div class="fx-sliderLabels">
            <span>0%</span>
            <span>25%</span>
            <span>50%</span>
            <span>75%</span>
            <span>100%</span>
          </div>
        </div>
      </div>

      <div class="fx-modal-card">
        <div class="field" style="margin-bottom:16px;">
          <div class="inLabel">Take Profit Price</div>
          <input id="fxTpPrice" type="number" inputmode="decimal" placeholder="0.0" step="0.01"/>
          <div class="inlinePct mutedPct" id="fxTpPct">—</div>
        </div>
        <div class="field">
          <div class="inLabel">Stop Loss Price</div>
          <input id="fxSlPrice" type="number" inputmode="decimal" placeholder="0.0" step="0.01"/>
          <div class="inlinePct mutedPct" id="fxSlPct">—</div>
        </div>
      </div>
    </div>
    <div class="m-ft">
      <button class="btn" id="fxTpslSubmit">Confirm TP/SL</button>
    </div>
  </div>


<script>
(function(){
  // ===== Positions Actions Modals wiring (event delegation, safe init) =====
  const $ = (sel, root=document) => root.querySelector(sel);
  const overlay = document.getElementById('fxActOverlay');
  const closeM = document.getElementById('fxCloseModal');
  const revM = document.getElementById('fxReverseModal');
  const tpslM = document.getElementById('fxTpslModal');
  const cancelAllM = document.getElementById('cancelAllModal');
  const cancelAllBtn = document.getElementById('cancelAllBtn');
  const cancelAllSubmit = document.getElementById('cancelAllConfirm');

  function showModal(m){
    if(!overlay || !m) return;
    overlay.style.display = 'block';
    m.style.display = 'flex';
    overlay.setAttribute('aria-hidden','false');
  }
  function hideAll(){
    if(overlay) { overlay.style.display='none'; overlay.setAttribute('aria-hidden','true'); }
    [closeM, revM, tpslM, cancelAllM].forEach(m=>{ if(m) m.style.display='none'; });
  }
  if(overlay){
    overlay.addEventListener('click', hideAll);
  }
  document.addEventListener('keydown', (e)=>{
    if(e.key === 'Escape') hideAll();
  });
  cancelAllBtn?.addEventListener('click', ()=>{
    showModal(cancelAllM);
  });
  cancelAllSubmit?.addEventListener('click', ()=>{
    window.__fxCancelAll?.();
    hideAll();
  });

  function parseNum(x){
    if(x==null) return NaN;
    const s = String(x).replace(/[^0-9.\-]/g,'');
    return parseFloat(s);
  }
  function getPosByIndex(idxStr){
    const d = window.__fx100Data;
    const idx = parseInt(idxStr,10);
    if(!d || !Array.isArray(d.positions) || !Number.isFinite(idx)) return null;
    return d.positions[idx] || null;
  }
  function posSide(p){
    const s = (p.side||'').toLowerCase();
    return s.includes('short') ? 'short' : 'long';
  }
  function setButtonStyle(btn, side){
    if(!btn) return;
    btn.classList.add('btn');
    btn.classList.remove('buy','sell');
    btn.classList.add(side==='short' ? 'sell' : 'buy');
  }
  function syncSlider(rangeEl, fillEl, knobEl){
    if(!rangeEl) return;
    const min = Number(rangeEl.min ?? 0);
    const max = Number(rangeEl.max ?? 100);
    const value = Math.min(max, Math.max(min, Number(rangeEl.value ?? min)));
    const pct = (max === min) ? 0 : ((value - min) / (max - min)) * 100;
    if(fillEl) fillEl.style.width = `${pct}%`;
    if(knobEl) knobEl.style.left = `${pct}%`;
  }
  function initSlider(rangeEl, fillEl, knobEl){
    if(!rangeEl) return;
    const handler = ()=>syncSlider(rangeEl, fillEl, knobEl);
    rangeEl.addEventListener('input', handler);
    rangeEl.addEventListener('change', handler);
    handler();
  }

  // ---- Market Close modal ----
  const closeTitle = $('#fxCloseTitle');
  const closeSidePill = $('#fxCloseSidePill');
  const closeSize = $('#fxCloseSize');
  const closePct = $('#fxClosePct');
  const closePctFill = $('#fxClosePctFill');
  const closePctKnob = $('#fxClosePctKnob');
  const closeUnit = $('#fxCloseUnit');
  const closeSubmit = $('#fxCloseSubmit');

  initSlider(closePct, closePctFill, closePctKnob);

  function openCloseModal(p){
    const side = posSide(p);
    if(closeTitle) closeTitle.textContent = `Market Close ${p.coin}`;
    if(closeSidePill) closeSidePill.textContent = side==='short' ? 'Short' : 'Long';
    if(closeSidePill){
      closeSidePill.style.borderColor = side==='short' ? 'rgba(244,91,91,.35)' : 'rgba(43,212,164,.35)';
      closeSidePill.style.color = side==='short' ? 'rgba(255,230,230,.92)' : 'rgba(215,255,242,.92)';
      closeSidePill.style.background = side==='short' ? 'rgba(244,91,91,.10)' : 'rgba(43,212,164,.10)';
    }
    if(closeUnit) closeUnit.textContent = 'ETH';
    const sizeEth = parseNum(p.size);
    if(closePct) closePct.value = '100';
    syncSlider(closePct, closePctFill, closePctKnob);
    if(closeSize) closeSize.value = Number.isFinite(sizeEth) ? String(sizeEth.toFixed(4)) : '';
    if(closeSubmit){
      closeSubmit.textContent = 'Confirm Close';
      setButtonStyle(closeSubmit, side); // close button can follow direction color subtly
    }
    showModal(closeM);
    closeSize?.focus();
  }
  closePct?.addEventListener('input', ()=>{
    syncSlider(closePct, closePctFill, closePctKnob);
    const p = closeM?.dataset.posIndex;
    const pos = getPosByIndex(p);
    if(!pos) return;
    const sizeEth = parseNum(pos.size);
    const pct = parseInt(closePct.value,10)/100;
    if(closeSize && Number.isFinite(sizeEth)) closeSize.value = (sizeEth*pct).toFixed(4);
  });
  closeSize?.addEventListener('input', ()=>{
    const p = closeM?.dataset.posIndex;
    const pos = getPosByIndex(p);
    if(!pos) return;
    const sizeEth = parseNum(pos.size);
    const v = parseNum(closeSize.value);
    if(Number.isFinite(sizeEth) && Number.isFinite(v) && closePct){
      const pct = Math.max(0, Math.min(100, Math.round((v/sizeEth)*100)));
      closePct.value = String(pct);
      syncSlider(closePct, closePctFill, closePctKnob);
    }
  });
  closeSubmit?.addEventListener('click', ()=>{ hideAll(); });
  document.addEventListener('click', (e)=>{
    const t = e.target;
    if(t && t.closest && t.closest('[data-fx-close]')){
      hideAll();
    }
  });
  document.addEventListener('click', (e)=>{
    const t = e.target;
    if(t && t.closest && t.closest('[data-cancel-all="close"]')){
      hideAll();
    }
  });

  // ---- Reverse modal ----
  const revTitle = $('#fxRevTitle');
  const revFrom = $('#fxRevFromPill');
  const revTo = $('#fxRevToPill');
  const revSize = $('#fxRevSize');
  const revPct = $('#fxRevPct');
  const revPctFill = $('#fxRevPctFill');
  const revPctKnob = $('#fxRevPctKnob');
  const revUnit = $('#fxRevUnit');
  const revSubmit = $('#fxRevSubmit');

  initSlider(revPct, revPctFill, revPctKnob);

  function openReverseModal(p){
    const from = posSide(p);
    const to = from==='short' ? 'long' : 'short';
    if(revTitle) revTitle.textContent = `Reverse ${p.coin}`;
    if(revFrom) revFrom.textContent = from==='short' ? 'From Short' : 'From Long';
    if(revTo) revTo.textContent = to==='short' ? 'To Short' : 'To Long';
    if(revUnit) revUnit.textContent = 'ETH';
    const sizeEth = parseNum(p.size);
    if(revPct) revPct.value = '100';
    syncSlider(revPct, revPctFill, revPctKnob);
    if(revSize) revSize.value = Number.isFinite(sizeEth) ? String(sizeEth.toFixed(4)) : '';
    if(revSubmit){
      revSubmit.textContent = to==='short' ? 'Confirm Reverse to Short' : 'Confirm Reverse to Long';
      setButtonStyle(revSubmit, to);
    }
    showModal(revM);
    revSize?.focus();
  }
  revPct?.addEventListener('input', ()=>{
    syncSlider(revPct, revPctFill, revPctKnob);
    const p = revM?.dataset.posIndex;
    const pos = getPosByIndex(p);
    if(!pos) return;
    const sizeEth = parseNum(pos.size);
    const pct = parseInt(revPct.value,10)/100;
    if(revSize && Number.isFinite(sizeEth)) revSize.value = (sizeEth*pct).toFixed(4);
  });
  revSize?.addEventListener('input', ()=>{
    const p = revM?.dataset.posIndex;
    const pos = getPosByIndex(p);
    if(!pos) return;
    const sizeEth = parseNum(pos.size);
    const v = parseNum(revSize.value);
    if(Number.isFinite(sizeEth) && Number.isFinite(v) && revPct){
      const pct = Math.max(0, Math.min(100, Math.round((v/sizeEth)*100)));
      revPct.value = String(pct);
      syncSlider(revPct, revPctFill, revPctKnob);
    }
  });
  revSubmit?.addEventListener('click', ()=>{ hideAll(); });
  document.addEventListener('click', (e)=>{
    const t = e.target;
    if(t && t.closest && t.closest('[data-fx-rev]')) hideAll();
  });

  // ---- TP/SL modal ----
  const tpslTitle = $('#fxTpslTitle');
  const tpslSidePill = $('#fxTpslSidePill');
  const tpslSize = $('#fxTpslSize');
  const tpslPct = $('#fxTpslPct');
  const tpslPctFill = $('#fxTpslPctFill');
  const tpslPctKnob = $('#fxTpslPctKnob');
  const tpslUnit = $('#fxTpslUnit');
  const tpPrice = $('#fxTpPrice');
  const slPrice = $('#fxSlPrice');
  const tpPct = $('#fxTpPct');
  const slPct = $('#fxSlPct');
  const tpslSubmit = $('#fxTpslSubmit');

  initSlider(tpslPct, tpslPctFill, tpslPctKnob);

  function fmtPct(v){
    if(!Number.isFinite(v)) return '—';
    const sign = v>=0 ? '+' : '';
    return sign + (v*100).toFixed(2) + '%';
  }
  function setPctDisplay(el, price, gain){
    if(!el) return;
    if(!Number.isFinite(price) || !Number.isFinite(gain)){
      el.textContent = '—';
      el.className = 'inlinePct mutedPct';
      return;
    }
    el.textContent = fmtPct(gain);
    el.className = `inlinePct ${gain >= 0 ? 'pos' : 'neg'}`;
  }
  function updateTpSlPerc(){
    const idx = tpslM?.dataset.posIndex;
    const pos = getPosByIndex(idx);
    if(!pos) return;
    const side = posSide(pos);
    const entry = parseNum(pos.entry);
    const tp = parseNum(tpPrice?.value);
    const sl = parseNum(slPrice?.value);
    if(!Number.isFinite(entry)){
      setPctDisplay(tpPct, NaN, NaN);
      setPctDisplay(slPct, NaN, NaN);
      return;
    }
    const tpGain = side==='long' ? (tp-entry)/entry : (entry-tp)/entry;
    const slGain = side==='long' ? (sl-entry)/entry : (entry-sl)/entry;
    setPctDisplay(tpPct, tp, tpGain);
    setPctDisplay(slPct, sl, slGain);
  }

  function openTpslModal(p){
    const side = posSide(p);
    if(tpslTitle) tpslTitle.textContent = `TP/SL for ${p.coin}`;
    if(tpslSidePill) tpslSidePill.textContent = side==='short' ? 'Short' : 'Long';
    if(tpslSidePill){
      tpslSidePill.style.borderColor = side==='short' ? 'rgba(244,91,91,.35)' : 'rgba(43,212,164,.35)';
      tpslSidePill.style.color = side==='short' ? 'rgba(255,230,230,.92)' : 'rgba(215,255,242,.92)';
      tpslSidePill.style.background = side==='short' ? 'rgba(244,91,91,.10)' : 'rgba(43,212,164,.10)';
    }
    if(tpslUnit) tpslUnit.textContent = 'ETH';
    const sizeEth = parseNum(p.size);
    if(tpslPct) tpslPct.value = '100';
    syncSlider(tpslPct, tpslPctFill, tpslPctKnob);
    if(tpslSize) tpslSize.value = Number.isFinite(sizeEth) ? String(sizeEth.toFixed(4)) : '';
    // default TP/SL prices: small offsets from entry for demo
    const entry = parseNum(p.entry);
    if(Number.isFinite(entry)){
      if(tpPrice) tpPrice.value = side==='long' ? String((entry*1.02).toFixed(2)) : String((entry*0.98).toFixed(2));
      if(slPrice) slPrice.value = side==='long' ? String((entry*0.98).toFixed(2)) : String((entry*1.02).toFixed(2));
    }else{
      if(tpPrice) tpPrice.value = '';
      if(slPrice) slPrice.value = '';
    }
    updateTpSlPerc();
    if(tpslSubmit){
      tpslSubmit.textContent = 'Confirm TP/SL';
      setButtonStyle(tpslSubmit, side);
    }
    showModal(tpslM);
    tpslSize?.focus();
  }

  tpslPct?.addEventListener('input', ()=>{
    syncSlider(tpslPct, tpslPctFill, tpslPctKnob);
    const idx = tpslM?.dataset.posIndex;
    const pos = getPosByIndex(idx);
    if(!pos) return;
    const sizeEth = parseNum(pos.size);
    const pct = parseInt(tpslPct.value,10)/100;
    if(tpslSize && Number.isFinite(sizeEth)) tpslSize.value = (sizeEth*pct).toFixed(4);
  });
  tpslSize?.addEventListener('input', ()=>{
    const idx = tpslM?.dataset.posIndex;
    const pos = getPosByIndex(idx);
    if(!pos) return;
    const sizeEth = parseNum(pos.size);
    const v = parseNum(tpslSize.value);
    if(Number.isFinite(sizeEth) && Number.isFinite(v) && tpslPct){
      const pct = Math.max(0, Math.min(100, Math.round((v/sizeEth)*100)));
      tpslPct.value = String(pct);
      syncSlider(tpslPct, tpslPctFill, tpslPctKnob);
    }
  });
  tpPrice?.addEventListener('input', updateTpSlPerc);
  slPrice?.addEventListener('input', updateTpSlPerc);
  tpslSubmit?.addEventListener('click', ()=>{ hideAll(); });
  document.addEventListener('click', (e)=>{
    const t = e.target;
    if(t && t.closest && t.closest('[data-fx-tpsl]')) hideAll();
  });

  // ===== Event delegation for actions (Positions only) =====
  document.addEventListener('click', (e)=>{
    const el = e.target;
    if(!el || !el.closest) return;

    const act = el.closest('.act-close, .act-reverse, .act-tpsl');
    if(!act) return;

    const tr = act.closest('tr');
    const idx = tr?.dataset?.posIndex;
    if(idx == null) return;

    const pos = getPosByIndex(idx);
    if(!pos) return;

    if(act.classList.contains('act-close')){
      closeM.dataset.posIndex = idx;
      openCloseModal(pos);
      return;
    }
    if(act.classList.contains('act-reverse')){
      revM.dataset.posIndex = idx;
      openReverseModal(pos);
      return;
    }
    if(act.classList.contains('act-tpsl')){
      tpslM.dataset.posIndex = idx;
      openTpslModal(pos);
      return;
    }
  });

})();
</script>

<script>
(function(){
  const containerId = "tvChart";
  let tvScriptLoaded = false;
  function initChart(){
    if(typeof TradingView === "undefined") return;
    if(window.__tvWidget) return;
    window.__tvWidget = new TradingView.widget({
      symbol: "CRYPTO:ETHUSD",
      interval: "60",
      autosize: true,
      timezone: "Etc/UTC",
      theme: "dark",
      style: "1",
      locale: "en",
      toolbar_bg: "transparent",
      container_id: containerId,
      hide_side_toolbar: false,
      allow_symbol_change: true,
      studies: [],
    });
  }
  function loadScript(){
    if(tvScriptLoaded) return;
    tvScriptLoaded = true;
    const script = document.createElement("script");
    script.src = "https://s3.tradingview.com/tv.js";
    script.onload = initChart;
    document.head.appendChild(script);
  }
  if(document.getElementById(containerId)){
    if(typeof TradingView === "undefined") loadScript();
    else initChart();
  }
})();
</script>

</body>
</html>
